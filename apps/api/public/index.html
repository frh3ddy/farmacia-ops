<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmacia Ops - Kitchen Sink</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007bff',
            'primary-hover': '#0056b3',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #007bff;
    }
    .tab.active {
      color: #007bff;
      border-bottom-color: #007bff;
      font-weight: 600;
    }
    .content {
      margin-top: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      min-height: 150px;
      font-family: monospace;
    }
    input[type="checkbox"] {
      margin-right: 8px;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #6c757d;
    }
    .btn-secondary:hover {
      background: #545b62;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .expandable {
      cursor: pointer;
    }
    .details {
      padding: 15px;
      background: #f8f9fa;
      margin-top: 10px;
      border-radius: 4px;
    }
    .json-view {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .sub-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .sub-tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid #ddd;
      background: white;
      font-size: 14px;
      color: #666;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .sub-tab:hover {
      border-color: #007bff;
      color: #007bff;
    }
    .sub-tab.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }
    .stat-card h4 {
      margin: 0 0 8px 0;
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }
    .risk-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .risk-low {
      background: #d4edda;
      color: #155724;
    }
    .risk-medium {
      background: #fff3cd;
      color: #856404;
    }
    .risk-high {
      background: #f8d7da;
      color: #721c24;
    }
    .risk-critical {
      background: #721c24;
      color: white;
    }
    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .progress-fill {
      height: 100%;
      background: #007bff;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [activeTab, setActiveTab] = useState('catalog-sync');

      return (
        <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-sm p-6">
          <h1 className="text-3xl font-bold text-gray-900 mb-6 pb-3 border-b-2 border-primary">üß™ Farmacia Ops - Kitchen Sink</h1>
          <div className="flex gap-2 mb-6 border-b-2 border-gray-200">
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'catalog-sync' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('catalog-sync')}
            >
              Catalog Sync
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'mappings' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('mappings')}
            >
              Catalog Mappings
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'products' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('products')}
            >
              Products
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'sales' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('sales')}
            >
              Sales
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'locations' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('locations')}
            >
              Locations
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'webhook-test' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('webhook-test')}
            >
              Webhook Test
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'inventory' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('inventory')}
            >
              Inventory
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'inventory-aging' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('inventory-aging')}
            >
              Inventory Aging
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'inventory-migration' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('inventory-migration')}
            >
              Inventory Migration
            </button>
            <button 
              className={`px-5 py-3 font-medium text-sm border-b-2 transition-colors ${
                activeTab === 'suppliers' 
                  ? 'border-primary text-primary font-semibold' 
                  : 'border-transparent text-gray-600 hover:text-primary'
              }`}
              onClick={() => setActiveTab('suppliers')}
            >
              Suppliers
            </button>
          </div>
          <div className="mt-6">
            {activeTab === 'catalog-sync' && <CatalogSync />}
            {activeTab === 'mappings' && <CatalogMappings />}
            {activeTab === 'products' && <Products />}
            {activeTab === 'sales' && <Sales />}
            {activeTab === 'locations' && <Locations />}
            {activeTab === 'webhook-test' && <WebhookTest />}
            {activeTab === 'inventory' && <Inventory />}
            {activeTab === 'inventory-aging' && <InventoryAging />}
            {activeTab === 'inventory-migration' && <InventoryMigration />}
            {activeTab === 'suppliers' && <Suppliers />}
          </div>
        </div>
      );
    }

    function CatalogSync() {
      const [locationId, setLocationId] = useState('');
      const [forceResync, setForceResync] = useState(false);
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const [error, setError] = useState(null);

      const handleSync = async () => {
        setLoading(true);
        setError(null);
        setResult(null);

        try {
          const response = await fetch('/admin/square/catalog/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              locationId: locationId || null,
              forceResync,
            }),
          });

          const data = await response.json();
          if (response.ok) {
            setResult(data);
          } else {
            setError(data.message || 'Sync failed');
          }
        } catch (err) {
          setError(err.message || 'Failed to sync catalog');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <h2>Catalog Sync</h2>
          <div className="form-group">
            <label>Location ID (optional):</label>
            <input
              type="text"
              value={locationId}
              onChange={(e) => setLocationId(e.target.value)}
              placeholder="Leave empty for global sync"
            />
          </div>
          <div className="form-group">
            <label>
              <input
                type="checkbox"
                checked={forceResync}
                onChange={(e) => setForceResync(e.target.checked)}
              />
              Force Resync (re-sync existing mappings)
            </label>
          </div>
          <button onClick={handleSync} disabled={loading}>
            {loading ? 'Syncing...' : 'Sync Catalog'}
          </button>

          {error && <div className="error">{error}</div>}
          {result && (
            <div className="success">
              <h3>Sync Results</h3>
              <p><strong>Total Variations Found:</strong> {result.result?.totalVariationsFound || 0}</p>
              <p><strong>Variations Processed:</strong> {result.result?.variationsProcessed || 0}</p>
              <p><strong>Products Created:</strong> {result.result?.productsCreated || 0}</p>
              <p><strong>Mappings Created:</strong> {result.result?.mappingsCreated || 0}</p>
              <p><strong>Mappings Skipped:</strong> {result.result?.mappingsSkipped || 0}</p>
              {result.result?.errors?.length > 0 && (
                <div>
                  <strong>Errors:</strong>
                  <ul>
                    {result.result.errors.map((err, i) => (
                      <li key={i}>{err.variationName}: {err.error}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    function CatalogMappings() {
      const [mappings, setMappings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      const fetchMappings = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/api/catalog/mappings');
          const data = await response.json();
          if (data.success) {
            setMappings(data.data || []);
          } else {
            setError('Failed to fetch mappings');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch mappings');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        fetchMappings();
      }, []);

      if (loading) return <div className="loading">Loading mappings...</div>;
      if (error) return <div className="error">{error}</div>;

      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <h2>Catalog Mappings ({mappings.length})</h2>
            <button onClick={fetchMappings} className="btn-secondary">Refresh</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Variation ID</th>
                <th>Product</th>
                <th>Location</th>
                <th>Synced At</th>
              </tr>
            </thead>
            <tbody>
              {mappings.map((mapping) => (
                <tr key={mapping.id}>
                  <td><code>{mapping.squareVariationId}</code></td>
                  <td>{mapping.product?.name || 'N/A'}</td>
                  <td>{mapping.location?.name || (mapping.locationId ? mapping.locationId : 'Global')}</td>
                  <td>{new Date(mapping.syncedAt).toLocaleString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function Products() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetch('/api/products')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              setProducts(data.data || []);
            } else {
              setError('Failed to fetch products');
            }
          })
          .catch(err => setError(err.message))
          .finally(() => setLoading(false));
      }, []);

      if (loading) return <div className="loading">Loading products...</div>;
      if (error) return <div className="error">{error}</div>;

      return (
        <div>
          <h2>Products ({products.length})</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Mappings</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {products.map((product) => (
                <tr key={product.id}>
                  <td><code>{product.id.substring(0, 8)}...</code></td>
                  <td>{product.name}</td>
                  <td>{product.sku || '-'}</td>
                  <td>{product.category?.name || '-'}</td>
                  <td><span className="badge badge-info">{product.catalogMappings?.length || 0}</span></td>
                  <td>{new Date(product.createdAt).toLocaleDateString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function Sales() {
      const [sales, setSales] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [expanded, setExpanded] = useState(new Set());

      useEffect(() => {
        fetch('/api/sales')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              setSales(data.data || []);
            } else {
              setError('Failed to fetch sales');
            }
          })
          .catch(err => setError(err.message))
          .finally(() => setLoading(false));
      }, []);

      const toggleExpand = (id) => {
        const newExpanded = new Set(expanded);
        if (newExpanded.has(id)) {
          newExpanded.delete(id);
        } else {
          newExpanded.add(id);
        }
        setExpanded(newExpanded);
      };

      if (loading) return <div className="loading">Loading sales...</div>;
      if (error) return <div className="error">{error}</div>;

      return (
        <div>
          <h2>Sales ({sales.length})</h2>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>Square ID</th>
                <th>Location</th>
                <th>Revenue</th>
                <th>Cost</th>
                <th>Profit</th>
                <th>Items</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {sales.map((sale) => (
                <React.Fragment key={sale.id}>
                  <tr className="expandable" onClick={() => toggleExpand(sale.id)}>
                    <td>{expanded.has(sale.id) ? '‚ñº' : '‚ñ∂'}</td>
                    <td><code>{sale.squareId}</code></td>
                    <td>{sale.location?.name || sale.locationId}</td>
                    <td>${parseFloat(sale.totalRevenue).toFixed(2)}</td>
                    <td>${parseFloat(sale.totalCost).toFixed(2)}</td>
                    <td>${parseFloat(sale.grossProfit).toFixed(2)}</td>
                    <td>{sale.items?.length || 0}</td>
                    <td>{new Date(sale.createdAt).toLocaleString()}</td>
                  </tr>
                  {expanded.has(sale.id) && (
                    <tr>
                      <td colSpan="8">
                        <div className="details">
                          <h4>Sale Items:</h4>
                          <table>
                            <thead>
                              <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Cost</th>
                              </tr>
                            </thead>
                            <tbody>
                              {sale.items?.map((item) => (
                                <tr key={item.id}>
                                  <td>{item.product?.name || 'N/A'}</td>
                                  <td>{item.quantity}</td>
                                  <td>${parseFloat(item.price).toFixed(2)}</td>
                                  <td>${parseFloat(item.cost).toFixed(2)}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function Locations() {
      const [locations, setLocations] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetch('/locations')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              setLocations(data.data || []);
            } else {
              setError('Failed to fetch locations');
            }
          })
          .catch(err => setError(err.message))
          .finally(() => setLoading(false));
      }, []);

      if (loading) return <div className="loading">Loading locations...</div>;
      if (error) return <div className="error">{error}</div>;

      return (
        <div>
          <h2>Locations ({locations.length})</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Address</th>
                <th>Status</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {locations.map((location) => (
                <tr key={location.id}>
                  <td><code>{location.id.substring(0, 8)}...</code></td>
                  <td>{location.name}</td>
                  <td>{location.address || '-'}</td>
                  <td>
                    <span className={`badge ${location.isActive ? 'badge-success' : 'badge-danger'}`}>
                      {location.isActive ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                  <td>{new Date(location.createdAt).toLocaleDateString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function WebhookTest() {
      const [paymentId, setPaymentId] = useState('');
      const [orderId, setOrderId] = useState('');
      const [locationId, setLocationId] = useState('L60AMVPDZJ48F');
      const [amount, setAmount] = useState(100);
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const [error, setError] = useState(null);
      const [isPaused, setIsPaused] = useState(false);
      const [statusLoading, setStatusLoading] = useState(true);

      useEffect(() => {
        // Fetch initial status
        fetchStatus();
      }, []);

      const fetchStatus = async () => {
        try {
          const response = await fetch('/api/webhooks/square/test/status');
          const data = await response.json();
          if (data.success) {
            setIsPaused(data.paused || false);
          }
        } catch (err) {
          console.error('Failed to fetch webhook status:', err);
        } finally {
          setStatusLoading(false);
        }
      };

      const handlePause = async () => {
        try {
          const response = await fetch('/api/webhooks/square/test/pause', {
            method: 'POST',
          });
          const data = await response.json();
          if (data.success) {
            setIsPaused(true);
          }
        } catch (err) {
          setError(err.message || 'Failed to pause webhook testing');
        }
      };

      const handleResume = async () => {
        try {
          const response = await fetch('/api/webhooks/square/test/resume', {
            method: 'POST',
          });
          const data = await response.json();
          if (data.success) {
            setIsPaused(false);
          }
        } catch (err) {
          setError(err.message || 'Failed to resume webhook testing');
        }
      };

      const handleTest = async () => {
        if (isPaused) {
          setError('Webhook testing is paused. Please resume to send test webhooks.');
          return;
        }

        setLoading(true);
        setError(null);
        setResult(null);

        try {
          const response = await fetch('/api/webhooks/square/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paymentId: paymentId || undefined,
              orderId: orderId || undefined,
              locationId,
              amount,
            }),
          });

          const data = await response.json();
          if (data.success) {
            setResult(data);
          } else {
            setError(data.message || 'Webhook test failed');
            if (data.paused) {
              setIsPaused(true);
            }
          }
        } catch (err) {
          setError(err.message || 'Failed to test webhook');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
            <h2>Test Webhook</h2>
            {!statusLoading && (
              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                <span style={{ 
                  padding: '5px 15px', 
                  background: isPaused ? '#dc3545' : '#28a745', 
                  color: 'white', 
                  borderRadius: '4px',
                  fontWeight: '600'
                }}>
                  {isPaused ? '‚è∏ PAUSED' : '‚ñ∂ ACTIVE'}
                </span>
                {isPaused ? (
                  <button onClick={handleResume} style={{ background: '#28a745' }}>
                    Resume
                  </button>
                ) : (
                  <button onClick={handlePause} style={{ background: '#dc3545' }}>
                    Pause
                  </button>
                )}
              </div>
            )}
          </div>
          <p style={{ marginBottom: '15px', color: '#666' }}>
            Simulate a Square payment webhook to test sale processing.
            {isPaused && <strong style={{ color: '#dc3545', display: 'block', marginTop: '5px' }}>‚ö†Ô∏è Webhook testing is paused. Jobs will not be sent.</strong>}
          </p>
          <div className="form-group">
            <label>Payment ID (optional, auto-generated if empty):</label>
            <input
              type="text"
              value={paymentId}
              onChange={(e) => setPaymentId(e.target.value)}
              placeholder="test_payment_123"
            />
          </div>
          <div className="form-group">
            <label>Order ID (optional, auto-generated if empty):</label>
            <input
              type="text"
              value={orderId}
              onChange={(e) => setOrderId(e.target.value)}
              placeholder="test_order_123"
            />
          </div>
          <div className="form-group">
            <label>Location ID:</label>
            <input
              type="text"
              value={locationId}
              onChange={(e) => setLocationId(e.target.value)}
              required
            />
          </div>
          <div className="form-group">
            <label>Amount (cents):</label>
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(parseInt(e.target.value) || 0)}
              min="1"
            />
          </div>
          <button onClick={handleTest} disabled={loading || isPaused}>
            {loading ? 'Sending...' : isPaused ? 'Paused - Cannot Send' : 'Send Test Webhook'}
          </button>

          {error && <div className="error">{error}</div>}
          {result && (
            <div className="success">
              <h3>Webhook Test Result</h3>
              <p><strong>Status:</strong> {result.message}</p>
              <p><strong>Event ID:</strong> {result.eventId}</p>
              <p style={{ marginTop: '10px' }}>Check the worker logs to see if the sale was processed.</p>
            </div>
          )}
        </div>
      );
    }

    function Inventory() {
      const [inventory, setInventory] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [creating, setCreating] = useState(false);
      const [createResult, setCreateResult] = useState(null);

      const fetchInventory = () => {
        setLoading(true);
        setError(null);
        fetch('/api/inventory')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              setInventory(data.data || []);
            } else {
              setError('Failed to fetch inventory');
            }
          })
          .catch(err => setError(err.message))
          .finally(() => setLoading(false));
      };

      useEffect(() => {
        fetchInventory();
      }, []);

      const handleCreateTestInventory = async () => {
        setCreating(true);
        setError(null);
        setCreateResult(null);

        try {
          // Include the specified product variation ID
          const response = await fetch('/api/inventory/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              squareVariationIds: ['YWASJW42SCO2V6MSXMTI55H5'], // The specified product
            }),
          });

          const data = await response.json();
          if (data.success) {
            setCreateResult(data);
            // Refresh inventory list
            fetchInventory();
          } else {
            setError(data.message || 'Failed to create test inventory');
          }
        } catch (err) {
          setError(err.message || 'Failed to create test inventory');
        } finally {
          setCreating(false);
        }
      };

      if (loading) return <div className="loading">Loading inventory...</div>;
      if (error) return <div className="error">{error}</div>;

      // Group inventory by product and location for better display
      const grouped = inventory.reduce((acc, item) => {
        const key = `${item.productId}-${item.locationId}`;
        if (!acc[key]) {
          acc[key] = {
            product: item.product,
            location: item.location,
            items: [],
            totalQuantity: 0,
          };
        }
        acc[key].items.push(item);
        acc[key].totalQuantity += item.quantity;
        return acc;
      }, {});

      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
            <h2>Inventory ({inventory.length} batches)</h2>
            <div style={{ display: 'flex', gap: '10px' }}>
              <button 
                onClick={handleCreateTestInventory} 
                disabled={creating}
                style={{ background: '#28a745' }}
              >
                {creating ? 'Creating...' : 'Pull Test Inventory'}
              </button>
              <button onClick={fetchInventory} className="btn-secondary">Refresh</button>
            </div>
          </div>
          
          {error && <div className="error">{error}</div>}
          {createResult && (
            <div className="success">
              <strong>Success!</strong> {createResult.message}
              <br />
              Created {createResult.count} inventory batch(es)
            </div>
          )}
          
          <div style={{ marginBottom: '20px', padding: '15px', background: '#f8f9fa', borderRadius: '4px' }}>
            <strong>Note:</strong> This is for testing purposes. A full inventory management feature will be added later.
            <br />
            <strong>Total Unique Products:</strong> {Object.keys(grouped).length}
            <br />
            <strong>Pull Test Inventory:</strong> Creates test inventory batches (100 units @ $5.00 each) for the specified Square variation ID and other products.
          </div>

          <h3>By Product & Location</h3>
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Location</th>
                <th>Total Qty</th>
                <th>Batches</th>
              </tr>
            </thead>
            <tbody>
              {Object.values(grouped).map((group, idx) => (
                <tr key={idx}>
                  <td>{group.product?.name || 'N/A'}</td>
                  <td>{group.location?.name || group.location?.squareId || 'N/A'}</td>
                  <td><strong>{group.totalQuantity}</strong></td>
                  <td>{group.items.length}</td>
                </tr>
              ))}
            </tbody>
          </table>

          <h3 style={{ marginTop: '30px' }}>All Inventory Batches (FIFO Order)</h3>
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Location</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Total Cost</th>
                <th>Received At</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {inventory.map((item) => (
                <tr key={item.id}>
                  <td>{item.product?.name || 'N/A'}</td>
                  <td>{item.location?.name || item.location?.squareId || 'N/A'}</td>
                  <td><strong>{item.quantity}</strong></td>
                  <td>${parseFloat(item.unitCost).toFixed(2)}</td>
                  <td>${(parseFloat(item.unitCost) * item.quantity).toFixed(2)}</td>
                  <td>{new Date(item.receivedAt).toLocaleDateString()}</td>
                  <td>{new Date(item.createdAt).toLocaleDateString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {inventory.length === 0 && (
            <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
              No inventory records found. Create inventory batches to track stock.
            </div>
          )}
        </div>
      );
    }

    function InventoryAging() {
      const [activeView, setActiveView] = useState('summary');
      const [summary, setSummary] = useState(null);
      const [products, setProducts] = useState([]);
      const [locations, setLocations] = useState([]);
      const [categories, setCategories] = useState([]);
      const [signals, setSignals] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      
      // Filters
      const [locationId, setLocationId] = useState('');
      const [categoryId, setCategoryId] = useState('');
      const [riskLevel, setRiskLevel] = useState('');
      const [severity, setSeverity] = useState('');
      const [signalType, setSignalType] = useState('');
      const [limit, setLimit] = useState('100');
      const [offset, setOffset] = useState('0');

      const fetchSummary = async () => {
        setLoading(true);
        setError(null);
        try {
          const params = new URLSearchParams();
          if (locationId && locationId.trim()) params.append('locationId', locationId.trim());
          if (categoryId && categoryId.trim()) params.append('categoryId', categoryId.trim());
          const response = await fetch(`/inventory/aging/summary?${params}`);
          const data = await response.json();
          if (response.ok) {
            setSummary(data);
          } else {
            setError(data.message || 'Failed to fetch summary');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch summary');
        } finally {
          setLoading(false);
        }
      };

      const fetchProducts = async () => {
        setLoading(true);
        setError(null);
        try {
          const params = new URLSearchParams();
          if (locationId && locationId.trim()) params.append('locationId', locationId.trim());
          if (categoryId && categoryId.trim()) params.append('categoryId', categoryId.trim());
          if (riskLevel && riskLevel.trim()) params.append('riskLevel', riskLevel.trim());
          if (limit && limit.trim()) params.append('limit', limit.trim());
          if (offset && offset.trim()) params.append('offset', offset.trim());
          const response = await fetch(`/inventory/aging/products?${params}`);
          const data = await response.json();
          if (response.ok) {
            setProducts(data.products || []);
          } else {
            setError(data.message || 'Failed to fetch products');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch products');
        } finally {
          setLoading(false);
        }
      };

      const fetchLocations = async () => {
        setLoading(true);
        setError(null);
        try {
          const params = new URLSearchParams();
          if (locationId && locationId.trim()) params.append('locationId', locationId.trim());
          const response = await fetch(`/inventory/aging/location?${params}`);
          const data = await response.json();
          if (response.ok) {
            setLocations(data.locations || []);
          } else {
            setError(data.message || 'Failed to fetch locations');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch locations');
        } finally {
          setLoading(false);
        }
      };

      const fetchCategories = async () => {
        setLoading(true);
        setError(null);
        try {
          const params = new URLSearchParams();
          if (categoryId && categoryId.trim()) params.append('categoryId', categoryId.trim());
          const response = await fetch(`/inventory/aging/category?${params}`);
          const data = await response.json();
          if (response.ok) {
            setCategories(data.categories || []);
          } else {
            setError(data.message || 'Failed to fetch categories');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch categories');
        } finally {
          setLoading(false);
        }
      };

      const fetchSignals = async () => {
        setLoading(true);
        setError(null);
        try {
          const params = new URLSearchParams();
          if (severity && severity.trim()) params.append('severity', severity.trim());
          if (signalType && signalType.trim()) params.append('type', signalType.trim());
          if (limit && limit.trim()) params.append('limit', limit.trim());
          const response = await fetch(`/inventory/aging/signals?${params}`);
          const data = await response.json();
          if (response.ok) {
            setSignals(data.signals || []);
          } else {
            setError(data.message || 'Failed to fetch signals');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch signals');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (activeView === 'summary') fetchSummary();
        else if (activeView === 'products') fetchProducts();
        else if (activeView === 'locations') fetchLocations();
        else if (activeView === 'categories') fetchCategories();
        else if (activeView === 'signals') fetchSignals();
      }, [activeView, locationId, categoryId, riskLevel, severity, signalType, limit, offset]);

      const getRiskClass = (risk) => {
        const r = risk?.toLowerCase() || '';
        if (r === 'critical') return 'risk-critical';
        if (r === 'high') return 'risk-high';
        if (r === 'medium') return 'risk-medium';
        return 'risk-low';
      };

      return (
        <div>
          <h2>Inventory Aging Analysis</h2>
          <p style={{ marginBottom: '20px', color: '#666' }}>
            Analyze inventory aging to identify slow-moving products, cash tied up, and actionable insights.
          </p>

          <div className="sub-tabs">
            <button 
              className={`sub-tab ${activeView === 'summary' ? 'active' : ''}`}
              onClick={() => setActiveView('summary')}
            >
              Summary
            </button>
            <button 
              className={`sub-tab ${activeView === 'products' ? 'active' : ''}`}
              onClick={() => setActiveView('products')}
            >
              Products
            </button>
            <button 
              className={`sub-tab ${activeView === 'locations' ? 'active' : ''}`}
              onClick={() => setActiveView('locations')}
            >
              Locations
            </button>
            <button 
              className={`sub-tab ${activeView === 'categories' ? 'active' : ''}`}
              onClick={() => setActiveView('categories')}
            >
              Categories
            </button>
            <button 
              className={`sub-tab ${activeView === 'signals' ? 'active' : ''}`}
              onClick={() => setActiveView('signals')}
            >
              Actionable Signals
            </button>
          </div>

          <div style={{ marginBottom: '20px', padding: '15px', background: '#f8f9fa', borderRadius: '4px' }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Location ID:</label>
                <input
                  type="text"
                  value={locationId}
                  onChange={(e) => setLocationId(e.target.value)}
                  placeholder="Filter by location"
                  style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Category ID:</label>
                <input
                  type="text"
                  value={categoryId}
                  onChange={(e) => setCategoryId(e.target.value)}
                  placeholder="Filter by category"
                  style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                />
              </div>
              {activeView === 'products' && (
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Risk Level:</label>
                  <select
                    value={riskLevel}
                    onChange={(e) => setRiskLevel(e.target.value)}
                    style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                  >
                    <option value="">All</option>
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                    <option value="CRITICAL">Critical</option>
                  </select>
                </div>
              )}
              {activeView === 'signals' && (
                <>
                  <div>
                    <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Severity:</label>
                    <select
                      value={severity}
                      onChange={(e) => setSeverity(e.target.value)}
                      style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                    >
                      <option value="">All</option>
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                      <option value="CRITICAL">Critical</option>
                    </select>
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Type:</label>
                    <select
                      value={signalType}
                      onChange={(e) => setSignalType(e.target.value)}
                      style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                    >
                      <option value="">All</option>
                      <option value="AT_RISK">At Risk</option>
                      <option value="SLOW_MOVING_EXPENSIVE">Slow Moving Expensive</option>
                      <option value="OVERSTOCKED_CATEGORY">Overstocked Category</option>
                    </select>
                  </div>
                </>
              )}
              {(activeView === 'products' || activeView === 'signals') && (
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: '600' }}>Limit:</label>
                  <input
                    type="number"
                    value={limit}
                    onChange={(e) => setLimit(e.target.value)}
                    style={{ width: '100%', padding: '6px', fontSize: '12px' }}
                    min="1"
                    max="500"
                  />
                </div>
              )}
            </div>
          </div>

          {error && <div className="error">{error}</div>}

          {loading && <div className="loading">Loading...</div>}

          {activeView === 'summary' && summary && (
            <div>
              <div className="stats-grid">
                <div className="stat-card">
                  <h4>Total Cash Tied Up</h4>
                  <div className="value">${summary.totalCashTiedUp?.toFixed(2) || '0.00'}</div>
                </div>
                <div className="stat-card">
                  <h4>Total Units</h4>
                  <div className="value">{summary.totalUnits || 0}</div>
                </div>
              </div>
              <h3>Aging Buckets</h3>
              <table>
                <thead>
                  <tr>
                    <th>Age Range</th>
                    <th>Cash Value</th>
                    <th>Units</th>
                    <th>Percentage</th>
                    <th>Visual</th>
                  </tr>
                </thead>
                <tbody>
                  {summary.buckets?.map((bucket, idx) => (
                    <tr key={idx}>
                      <td><strong>{bucket.bucket?.label || 'N/A'}</strong></td>
                      <td>${bucket.cashValue?.toFixed(2) || '0.00'}</td>
                      <td>{bucket.unitCount || 0}</td>
                      <td>{bucket.percentageOfTotal?.toFixed(1) || '0.0'}%</td>
                      <td style={{ width: '200px' }}>
                        <div className="progress-bar">
                          <div 
                            className="progress-fill" 
                            style={{ width: `${bucket.percentageOfTotal || 0}%` }}
                          />
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {activeView === 'products' && products.length > 0 && (
            <div>
              <h3>Product Aging Analysis ({products.length})</h3>
              <table>
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Cash Tied Up</th>
                    <th>Units</th>
                    <th>Oldest Age (days)</th>
                    <th>Risk Level</th>
                    <th>Buckets</th>
                  </tr>
                </thead>
                <tbody>
                  {products.map((product) => (
                    <tr key={product.productId}>
                      <td><strong>{product.productName}</strong></td>
                      <td>{product.categoryName || '-'}</td>
                      <td>${product.totalCashTiedUp?.toFixed(2) || '0.00'}</td>
                      <td>{product.totalUnits || 0}</td>
                      <td>{product.oldestBatchAge || 0}</td>
                      <td>
                        <span className={`risk-badge ${getRiskClass(product.riskLevel)}`}>
                          {product.riskLevel || 'LOW'}
                        </span>
                      </td>
                      <td>
                        {product.bucketDistribution?.map((b, i) => (
                          <span key={i} style={{ marginRight: '5px', fontSize: '11px' }}>
                            {b.bucket?.label}: {b.percentageOfTotal?.toFixed(0)}%
                          </span>
                        ))}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {activeView === 'locations' && locations.length > 0 && (
            <div>
              <h3>Location Aging Analysis ({locations.length})</h3>
              <table>
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>Cash Tied Up</th>
                    <th>Units</th>
                    <th>At-Risk Products</th>
                    <th>Buckets</th>
                  </tr>
                </thead>
                <tbody>
                  {locations.map((location) => (
                    <tr key={location.locationId}>
                      <td><strong>{location.locationName}</strong></td>
                      <td>${location.totalCashTiedUp?.toFixed(2) || '0.00'}</td>
                      <td>{location.totalUnits || 0}</td>
                      <td>
                        <span className={location.atRiskProducts > 0 ? 'risk-badge risk-high' : 'risk-badge risk-low'}>
                          {location.atRiskProducts || 0}
                        </span>
                      </td>
                      <td>
                        {location.bucketDistribution?.map((b, i) => (
                          <span key={i} style={{ marginRight: '5px', fontSize: '11px' }}>
                            {b.bucket?.label}: ${b.cashValue?.toFixed(0)}
                          </span>
                        ))}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {activeView === 'categories' && categories.length > 0 && (
            <div>
              <h3>Category Aging Analysis ({categories.length})</h3>
              <table>
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Cash Tied Up</th>
                    <th>Units</th>
                    <th>Avg Age (days)</th>
                    <th>Buckets</th>
                  </tr>
                </thead>
                <tbody>
                  {categories.map((category) => (
                    <tr key={category.categoryId}>
                      <td><strong>{category.categoryName}</strong></td>
                      <td>${category.totalCashTiedUp?.toFixed(2) || '0.00'}</td>
                      <td>{category.totalUnits || 0}</td>
                      <td>{category.averageAge?.toFixed(1) || '0.0'}</td>
                      <td>
                        {category.bucketDistribution?.map((b, i) => (
                          <span key={i} style={{ marginRight: '5px', fontSize: '11px' }}>
                            {b.bucket?.label}: ${b.cashValue?.toFixed(0)}
                          </span>
                        ))}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {activeView === 'signals' && signals.length > 0 && (
            <div>
              <h3>Actionable Signals ({signals.length})</h3>
              <table>
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Severity</th>
                    <th>Entity</th>
                    <th>Message</th>
                    <th>Cash at Risk</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {signals.map((signal, idx) => (
                    <tr key={idx}>
                      <td>
                        <span className="badge badge-info">
                          {signal.type?.replace(/_/g, ' ')}
                        </span>
                      </td>
                      <td>
                        <span className={`risk-badge ${getRiskClass(signal.severity)}`}>
                          {signal.severity}
                        </span>
                      </td>
                      <td>
                        <strong>{signal.entityName}</strong>
                        <br />
                        <small style={{ color: '#666' }}>{signal.entityType}</small>
                      </td>
                      <td>{signal.message}</td>
                      <td>
                        {signal.cashAtRisk ? `$${signal.cashAtRisk.toFixed(2)}` : '-'}
                      </td>
                      <td>
                        <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '12px' }}>
                          {signal.recommendedActions?.map((action, i) => (
                            <li key={i}>{action}</li>
                          ))}
                        </ul>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {!loading && (
            (activeView === 'summary' && !summary) ||
            (activeView === 'products' && products.length === 0) ||
            (activeView === 'locations' && locations.length === 0) ||
            (activeView === 'categories' && categories.length === 0) ||
            (activeView === 'signals' && signals.length === 0)
          ) && (
            <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
              No data available. Make sure you have inventory with quantity &gt; 0.
            </div>
          )}
        </div>
      );
    }

    function InventoryMigration() {
      const [step, setStep] = useState('extract'); // 'extract', 'approve', 'migrate', 'preview'
      const [locations, setLocations] = useState([]);
      const [selectedLocations, setSelectedLocations] = useState([]);
      const [cutoverDate, setCutoverDate] = useState(new Date().toISOString().split('T')[0]);
      const [costBasis, setCostBasis] = useState('DESCRIPTION');
      const [loading, setLoading] = useState(false);
      const [loadingLocations, setLoadingLocations] = useState(false);
      const [error, setError] = useState(null);
      const [extractionResult, setExtractionResult] = useState(null);
      const [approvedCosts, setApprovedCosts] = useState({});
      const [migrationResult, setMigrationResult] = useState(null);
      const [previewResult, setPreviewResult] = useState(null);
      const [batchSize, setBatchSize] = useState(100);
      const [extractionBatchSize, setExtractionBatchSize] = useState(100);
      const [currentCutoverId, setCurrentCutoverId] = useState(null);
      const [currentExtractionSessionId, setCurrentExtractionSessionId] = useState(null);
      const [editedExtractionResults, setEditedExtractionResults] = useState({});
      const [supplierSuggestions, setSupplierSuggestions] = useState({});
      const [openAutocomplete, setOpenAutocomplete] = useState({});
      const [supplierNameMappings, setSupplierNameMappings] = useState([]); // Track supplier name changes: [{ supplierOriginal: 'L', new: 'Levi' }]
      const [allSuppliers, setAllSuppliers] = useState([]); // All suppliers with initials for autocomplete
      const [activeTab, setActiveTab] = useState('WITH_EXTRACTION'); // Active tab: 'WITH_EXTRACTION', 'TOTAL_PRODUCTS', 'REMAINING'

      // Close autocomplete when clicking outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (!event.target.closest('.autocomplete-container')) {
            setOpenAutocomplete({});
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      useEffect(() => {
        fetchLocations();
        fetchAllSuppliers();
      }, []);

      const fetchAllSuppliers = async () => {
        try {
          const response = await fetch('/admin/inventory/cutover/suppliers');
          const data = await response.json();
          if (data.success) {
            setAllSuppliers(data.suppliers || []);
          }
        } catch (err) {
          console.error('Failed to fetch suppliers:', err);
        }
      };

      // Function to get supplier suggestions based on input
      const getSupplierSuggestions = (inputValue, originalSupplierName) => {
        if (!inputValue || inputValue.trim().length === 0) {
          return [];
        }

        const searchTerm = inputValue.trim().toLowerCase();
        const suggestions = [];

        // 1. First, check if input matches a supplier initial (case-insensitive) - EXACT match
        const initialMatches = allSuppliers
          .filter(s => s.initials && s.initials.toLowerCase() === searchTerm && s.isActive)
          .map(s => ({ id: s.id, name: s.name, contactInfo: s.contactInfo, matchType: 'initial', isExactMatch: true }));

        if (initialMatches.length > 0) {
          suggestions.push(...initialMatches);
        }

        // 2. Check if input matches a supplier name exactly (case-insensitive)
        const exactNameMatches = allSuppliers
          .filter(s => s.isActive && s.name.toLowerCase() === searchTerm)
          .map(s => ({ id: s.id, name: s.name, contactInfo: s.contactInfo, matchType: 'name', isExactMatch: true }))
          .filter(s => !suggestions.find(existing => existing.id === s.id)); // Avoid duplicates

        if (exactNameMatches.length > 0) {
          suggestions.push(...exactNameMatches);
        }

        // 3. Check local mappings for renamed suppliers
        const mappingMatches = supplierNameMappings
          .filter(m => 
            m.supplierOriginal.toLowerCase() === searchTerm || 
            m.new.toLowerCase() === searchTerm
          )
          .map(m => {
            // Find the supplier in allSuppliers by the mapped name
            const supplier = allSuppliers.find(s => s.name === m.new);
            if (supplier && supplier.isActive) {
              return { id: supplier.id, name: supplier.name, contactInfo: supplier.contactInfo, matchType: 'mapping', isExactMatch: true };
            }
            // If not found in suppliers, return a virtual suggestion
            return { id: null, name: m.new, contactInfo: null, matchType: 'mapping', isExactMatch: true };
          })
          .filter((s, index, self) => index === self.findIndex(t => t.name === s.name)); // Remove duplicates

        suggestions.push(...mappingMatches);

        // 4. Check supplier names that start with or contain the search term (partial matches)
        if (suggestions.length === 0) {
          const nameMatches = allSuppliers
            .filter(s => {
              if (!s.isActive) return false;
              const nameLower = s.name.toLowerCase();
              return nameLower.startsWith(searchTerm) || nameLower.includes(searchTerm);
            })
            .map(s => ({ id: s.id, name: s.name, contactInfo: s.contactInfo, matchType: 'name', isExactMatch: false }))
            .filter(s => !suggestions.find(existing => existing.name === s.name)); // Avoid duplicates

          suggestions.push(...nameMatches);
        }

        return suggestions.slice(0, 10); // Limit to 10 suggestions
      };

      // Function to auto-select supplier if there's an exact single match
      const autoSelectSupplier = (inputValue, originalSupplierName, productId, entryIdx, isExtractedEntry, currentResult) => {
        if (!inputValue || inputValue.trim().length === 0) {
          return null;
        }

        const suggestions = getSupplierSuggestions(inputValue, originalSupplierName);
        
        // Auto-select if there's exactly one exact match (by initial or exact name)
        const exactMatches = suggestions.filter(s => s.isExactMatch);
        
        if (exactMatches.length === 1) {
          const supplier = exactMatches[0];
          
          // Use functional update to ensure we have the latest state
          setEditedExtractionResults(prevResults => {
            const newResults = { ...prevResults };
            
            if (isExtractedEntry) {
              // For extracted entries
              if (!newResults[productId]) {
                newResults[productId] = { ...currentResult };
              }
              if (!newResults[productId].extractedEntries) {
                newResults[productId].extractedEntries = [...currentResult.extractedEntries];
              }
              if (!newResults[productId].extractedEntries[entryIdx]) {
                newResults[productId].extractedEntries[entryIdx] = { ...currentResult.extractedEntries[entryIdx] };
              }
              
              newResults[productId].extractedEntries[entryIdx] = {
                ...newResults[productId].extractedEntries[entryIdx],
                editedSupplierName: supplier.name,
                supplierId: supplier.id,
              };
              
              // Check if this entry is selected
              const isSelected = newResults[productId].extractedEntries[entryIdx].isSelected !== undefined 
                ? newResults[productId].extractedEntries[entryIdx].isSelected 
                : (entryIdx === newResults[productId].extractedEntries.length - 1);
              
              if (isSelected) {
                newResults[productId].selectedSupplierName = supplier.name;
                newResults[productId].selectedSupplierId = supplier.id;
              }
            } else {
              // For manual input
              if (!newResults[productId]) {
                newResults[productId] = { ...currentResult };
              }
              newResults[productId].selectedSupplierName = supplier.name;
              newResults[productId].selectedSupplierId = supplier.id;
            }
            
            return newResults;
          });
          
          // Update supplier name mapping if name changed (for extracted entries only)
          if (isExtractedEntry && originalSupplierName) {
            const isUnknownOrGeneral = !originalSupplierName || originalSupplierName === 'Unknown' || originalSupplierName === 'General';
            if (!isUnknownOrGeneral && supplier.name !== originalSupplierName) {
              setSupplierNameMappings(prev => {
                const filtered = prev.filter(m => m.supplierOriginal !== originalSupplierName);
                return [...filtered, { supplierOriginal: originalSupplierName, new: supplier.name }];
              });
            }
          }
          
          // Close autocomplete
          if (isExtractedEntry) {
            setOpenAutocomplete(prev => {
              const newState = { ...prev };
              delete newState[`${productId}_${entryIdx}`];
              return newState;
            });
          } else {
            setOpenAutocomplete(prev => {
              const newState = { ...prev };
              delete newState[productId];
              return newState;
            });
          }
          
          return supplier.name; // Return the supplier name so we can use it to update the input
        }
        
        return null; // No auto-selection
      };

      const fetchLocations = async () => {
        setLoadingLocations(true);
        setError(null);
        try {
          const response = await fetch('/locations');
          const data = await response.json();
          if (data.success) {
            setLocations(data.data || []);
          } else {
            setError(data.message || 'Failed to fetch locations');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch locations');
          console.error('Failed to fetch locations:', err);
        } finally {
          setLoadingLocations(false);
        }
      };

      const syncLocationsFromSquare = async () => {
        setLoadingLocations(true);
        setError(null);
        try {
          const response = await fetch('/locations/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          const data = await response.json();
          if (data.success) {
            // Refresh locations after sync
            await fetchLocations();
            alert(`Successfully synced locations: ${data.result.created} created, ${data.result.updated} updated`);
          } else {
            setError(data.message || 'Failed to sync locations from Square');
          }
        } catch (err) {
          setError(err.message || 'Failed to sync locations from Square');
          console.error('Failed to sync locations:', err);
        } finally {
          setLoadingLocations(false);
        }
      };

      const handleExtractCosts = async (continueExtraction = false) => {
        if (!continueExtraction && selectedLocations.length === 0) {
          setError('Please select at least one location');
          return;
        }

        setLoading(true);
        setError(null);
        if (!continueExtraction) {
          setExtractionResult(null);
          setCurrentExtractionSessionId(null);
        }

        try {
          const response = await fetch('/admin/inventory/cutover/extract-costs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              locationIds: selectedLocations,
              costBasis: 'DESCRIPTION',
              batchSize: continueExtraction ? null : (extractionBatchSize && extractionBatchSize > 0 ? extractionBatchSize : null),
              extractionSessionId: continueExtraction ? currentExtractionSessionId : null,
            }),
          });

          const data = await response.json();
          if (response.ok && data.success) {
            const result = data.result;
            
            // Match supplier initials to full supplier names and apply supplier name mappings
            if (result.extractionResults) {
              result.extractionResults = result.extractionResults.map(productResult => {
                if (productResult.extractedEntries) {
                  productResult.extractedEntries = productResult.extractedEntries.map(entry => {
                    const originalSupplier = entry.supplier;
                    let matchedSupplierName = null;
                    let matchedSupplierId = null;
                    
                    // DO NOT apply matching for Unknown/General/null suppliers
                    const isUnknownOrGeneral = !originalSupplier || originalSupplier === 'Unknown' || originalSupplier === 'General';
                    
                    if (!isUnknownOrGeneral && originalSupplier) {
                      // First, try to match by supplier initial (case-insensitive)
                      const supplierInitial = originalSupplier.trim().toLowerCase();
                      const matchedByInitial = allSuppliers.find(s => 
                        s.initials && s.initials.toLowerCase() === supplierInitial && s.isActive
                      );
                      
                      if (matchedByInitial) {
                        matchedSupplierName = matchedByInitial.name;
                        matchedSupplierId = matchedByInitial.id;
                      } else {
                        // Second, try to match by supplier name (case-insensitive exact match)
                        const matchedByName = allSuppliers.find(s => 
                          s.name.toLowerCase() === originalSupplier.toLowerCase() && s.isActive
                        );
                        
                        if (matchedByName) {
                          matchedSupplierName = matchedByName.name;
                          matchedSupplierId = matchedByName.id;
                        }
                      }
                      
                      // Third, check supplier name mappings if no direct match found
                      if (!matchedSupplierName && supplierNameMappings.length > 0) {
                        const mapping = supplierNameMappings.find(m => m.supplierOriginal === originalSupplier);
                        if (mapping) {
                          matchedSupplierName = mapping.new;
                          // Try to find supplier ID for the mapped name
                          const mappedSupplier = allSuppliers.find(s => 
                            s.name === mapping.new && s.isActive
                          );
                          if (mappedSupplier) {
                            matchedSupplierId = mappedSupplier.id;
                          }
                        }
                      }
                    }
                    
                    // Return entry with matched supplier name if found, otherwise keep original
                    // Keep original supplier for display, but use matched name for the input field
                    if (matchedSupplierName) {
                      return {
                        ...entry,
                        supplier: originalSupplier, // Keep original extracted value for display (e.g., "L")
                        editedSupplierName: matchedSupplierName, // Use matched full name for input (e.g., "Levic")
                        supplierId: matchedSupplierId
                      };
                    }
                    
                    return entry;
                  });
                  
                  // Also update selectedSupplierName if the last entry (default selected) has a match
                  const lastEntry = productResult.extractedEntries[productResult.extractedEntries.length - 1];
                  if (lastEntry && lastEntry.editedSupplierName) {
                    productResult.selectedSupplierName = lastEntry.editedSupplierName;
                    productResult.selectedSupplierId = lastEntry.supplierId;
                  }
                }
                return productResult;
              });
            }
            
            // Clear previous batch items from editedExtractionResults, keep only current batch
            if (continueExtraction && result.extractionResults) {
              const currentBatchProductIds = new Set(result.extractionResults.map(r => r.productId));
              setEditedExtractionResults(prev => {
                const filtered = {};
                // Only keep items from current batch
                currentBatchProductIds.forEach(productId => {
                  if (prev[productId]) {
                    filtered[productId] = prev[productId];
                  }
                });
                return filtered;
              });
            } else if (!continueExtraction) {
              // New extraction session - clear all edited results
              setEditedExtractionResults({});
            }
            
            setExtractionResult(result);
            if (result.extractionSessionId) {
              setCurrentExtractionSessionId(result.extractionSessionId);
            }
            // Allow moving to approve step even if incomplete
            // User can choose to review partial results or continue extraction
          } else {
            setError(data.message || 'Failed to extract costs');
          }
        } catch (err) {
          setError(err.message || 'Failed to extract costs');
        } finally {
          setLoading(false);
        }
      };

      const handleApproveCosts = async () => {
        if (!extractionResult) return;

        setLoading(true);
        setError(null);

        try {
          // Use edited results if available, otherwise use original
          const resultsToUse = Object.keys(editedExtractionResults).length > 0
            ? extractionResult.extractionResults.map(r => editedExtractionResults[r.productId] || r)
            : extractionResult.extractionResults;

          const approvedCostsArray = resultsToUse
            .filter(r => {
              const cost = r.selectedCost || (r.extractedEntries.length > 0 ? r.extractedEntries[r.extractedEntries.length - 1]?.amount : null);
              return cost !== null && cost !== undefined;
            })
            .map(r => {
              const edited = editedExtractionResults[r.productId] || r;
              // Find the selected entry (marked with isSelected: true)
              const selectedEntry = edited.extractedEntries.find(e => e.isSelected) 
                || (edited.extractedEntries.length > 0 ? edited.extractedEntries[edited.extractedEntries.length - 1] : null);
              const cost = edited.selectedCost !== null && edited.selectedCost !== undefined 
                ? edited.selectedCost 
                : (selectedEntry ? (selectedEntry.editedCost !== null && selectedEntry.editedCost !== undefined ? selectedEntry.editedCost : selectedEntry.amount) : null);
              const supplierId = edited.selectedSupplierId || selectedEntry?.supplierId || null;
              const supplierName = edited.selectedSupplierName || (selectedEntry ? (selectedEntry.editedSupplierName || selectedEntry.supplier) : null) || 'General';
              // Check if preferred supplier (from dropdown) matches selected supplier
              const preferredSupplierName = edited.preferredSupplierName !== undefined ? edited.preferredSupplierName : supplierName;
              const isPreferred = preferredSupplierName === supplierName;

              return {
                productId: r.productId,
                cost: cost,
                source: edited.extractedEntries.length > 0 ? 'EXTRACTED_SELECTED' : 'MANUAL_INPUT',
                supplierId: supplierId,
                supplierName: supplierName,
                isPreferred: isPreferred,
              };
            });

          // Collect all entries marked to add to supplier history
          const entriesToAddToHistory = [];
          resultsToUse.forEach(r => {
            const edited = editedExtractionResults[r.productId] || r;
            edited.extractedEntries.forEach((entry, idx) => {
              // Check if this entry should be added to history
              const shouldAdd = entry.addToHistory !== undefined 
                ? entry.addToHistory 
                : (idx === edited.extractedEntries.length - 1); // Default: only selected entry
              
              if (shouldAdd && entry.amount) {
                const supplierName = entry.editedSupplierName || entry.supplier;
                if (supplierName && supplierName.trim() && supplierName !== 'General') {
                  entriesToAddToHistory.push({
                    productId: r.productId,
                    supplierName: supplierName.trim(),
                    supplierId: entry.supplierId || null,
                    cost: entry.amount,
                    effectiveAt: null, // Will use cutover date
                  });
                }
              }
            });
          });

          const response = await fetch('/admin/inventory/cutover/approve-costs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cutoverId: extractionResult.cutoverId,
              approvedCosts: approvedCostsArray,
              entriesToAddToHistory: entriesToAddToHistory.length > 0 ? entriesToAddToHistory : null,
              rejectedProducts: [],
              effectiveAt: cutoverDate + 'T00:00:00Z',
            }),
          });

          const data = await response.json();
          if (response.ok && data.success) {
            setApprovedCosts(approvedCostsArray.reduce((acc, ac) => {
              acc[ac.productId] = ac.cost;
              return acc;
            }, {}));
            setStep('migrate');
          } else {
            setError(data.message || 'Failed to approve costs');
          }
        } catch (err) {
          setError(err.message || 'Failed to approve costs');
        } finally {
          setLoading(false);
        }
      };

      const handlePreview = async () => {
        if (selectedLocations.length === 0) {
          setError('Please select at least one location');
          return;
        }

        setLoading(true);
        setError(null);
        setPreviewResult(null);

        try {
          const response = await fetch('/admin/inventory/cutover/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cutoverDate: cutoverDate + 'T00:00:00Z',
              locationIds: selectedLocations,
              costBasis: costBasis,
              approvedCosts: Object.keys(approvedCosts).map(productId => ({
                productId,
                cost: approvedCosts[productId],
              })),
            }),
          });

          const data = await response.json();
          if (response.ok) {
            setPreviewResult(data);
          } else {
            setError(data.message || 'Failed to preview migration');
          }
        } catch (err) {
          setError(err.message || 'Failed to preview migration');
        } finally {
          setLoading(false);
        }
      };

      const handleMigrate = async (continueMigration = false) => {
        if (!continueMigration && selectedLocations.length === 0) {
          setError('Please select at least one location');
          return;
        }

        if (!continueMigration && !window.confirm('Are you sure you want to execute the inventory migration? This will create opening balances and lock the system.')) {
          return;
        }

        setLoading(true);
        setError(null);
        if (!continueMigration) {
          setMigrationResult(null);
        }

        try {
          let response;
          if (continueMigration && currentCutoverId) {
            // Continue batch migration
            response = await fetch('/admin/inventory/cutover/continue', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                cutoverId: currentCutoverId,
              }),
            });
          } else {
            // Start new migration
            response = await fetch('/admin/inventory/cutover', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                cutoverDate: cutoverDate + 'T00:00:00Z',
                locationIds: selectedLocations,
                costBasis: costBasis,
                ownerApproved: true,
                approvalId: extractionResult?.cutoverId,
                manualCosts: Object.keys(approvedCosts).map(productId => ({
                  productId,
                  cost: approvedCosts[productId],
                })),
                batchSize: batchSize && batchSize > 0 ? batchSize : null,
              }),
            });
          }

          const data = await response.json();
          if (response.ok && data.success) {
            setMigrationResult(data.result);
            if (data.result.cutoverId) {
              setCurrentCutoverId(data.result.cutoverId);
            }
            if (data.result.isComplete) {
              setStep('complete');
            } else {
              setStep('migrate'); // Stay on migrate step to show continue button
            }
          } else {
            setError(data.message || 'Migration failed');
          }
        } catch (err) {
          setError(err.message || 'Migration failed');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="max-w-4xl mx-auto space-y-6">
          <div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Inventory Migration & Cutover</h2>
            <p className="text-gray-600 mb-6">
              Migrate inventory from Square to the new FIFO-based system. This process creates opening balances and locks the system.
            </p>
          </div>

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
              {error}
            </div>
          )}

          <div className="space-y-1">
            <label className="block text-sm font-medium text-gray-700">Cutover Date</label>
            <input
              type="date"
              value={cutoverDate}
              onChange={(e) => setCutoverDate(e.target.value)}
              className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
            />
          </div>

          <div className="space-y-1">
            <div className="flex justify-between items-center mb-2">
              <label className="block text-sm font-medium text-gray-700">Locations</label>
              <div className="flex gap-2">
                <button 
                  onClick={syncLocationsFromSquare} 
                  disabled={loadingLocations}
                  className="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loadingLocations ? 'Syncing...' : 'Sync from Square'}
                </button>
                <button 
                  onClick={fetchLocations} 
                  disabled={loadingLocations}
                  className="px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loadingLocations ? 'Loading...' : 'Refresh'}
                </button>
              </div>
            </div>
            {locations.length === 0 ? (
              <div className="p-4 bg-gray-50 rounded-lg text-gray-600 text-center border border-gray-200">
                No locations found. Click "Sync from Square" to fetch locations.
              </div>
            ) : (
              <div className="flex flex-col gap-2 max-h-72 overflow-y-auto p-3 border border-gray-200 rounded-lg bg-white">
                {locations.map(loc => (
                  <label key={loc.id} className="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input
                      type="checkbox"
                      checked={selectedLocations.includes(loc.id)}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setSelectedLocations([...selectedLocations, loc.id]);
                        } else {
                          setSelectedLocations(selectedLocations.filter(id => id !== loc.id));
                        }
                      }}
                      className="rounded text-primary border-gray-300 focus:ring-primary"
                    />
                    <span className="ml-2 text-sm text-gray-700">
                      {loc.name} {loc.squareId && <span className="text-gray-500">({loc.squareId})</span>}
                    </span>
                  </label>
                ))}
              </div>
            )}
          </div>

          <div className="space-y-1">
            <label className="block text-sm font-medium text-gray-700">Cost Basis</label>
            <select
              value={costBasis}
              onChange={(e) => setCostBasis(e.target.value)}
              className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
            >
              <option value="DESCRIPTION">Extract from Description</option>
              <option value="SQUARE_COST">Square Cost</option>
              <option value="MANUAL_INPUT">Manual Input</option>
              <option value="AVERAGE_COST">Average Cost</option>
            </select>
          </div>

          <div className="space-y-1">
            <label className="block text-sm font-medium text-gray-700">Batch Size (items per batch, leave empty for no batching)</label>
            <input
              type="number"
              value={batchSize || ''}
              onChange={(e) => {
                const value = e.target.value;
                setBatchSize(value === '' ? '' : (parseInt(value) || ''));
              }}
              placeholder="e.g., 100"
              min="1"
              className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
            />
            <p className="text-xs text-gray-500 mt-1">
              Process migration in batches to avoid timeouts. Leave empty to process all items at once.
            </p>
          </div>

          {step === 'extract' && (
            <div className="space-y-6">
              {costBasis === 'DESCRIPTION' ? (
                <div className="space-y-4">
                  <p className="text-gray-600">
                    Cost extraction is required for "Extract from Description" cost basis.
                    This will process all products to extract costs from their descriptions.
                  </p>
                  
                  <div className="space-y-1">
                    <label className="block text-sm font-medium text-gray-700">Extraction Batch Size (items per batch, leave empty for no batching)</label>
                    <input
                      type="number"
                      value={extractionBatchSize || ''}
                      onChange={(e) => {
                        const value = e.target.value;
                        setExtractionBatchSize(value === '' ? '' : (parseInt(value) || ''));
                      }}
                      placeholder="e.g., 100"
                      min="1"
                      className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Process extraction in batches to avoid timeouts. Leave empty to process all items at once.
                    </p>
                  </div>

                  {extractionResult && !extractionResult.isComplete && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h4 className="font-semibold text-yellow-800 mb-2">Extraction Batch Progress</h4>
                      <p className="text-sm text-yellow-700 mb-1"><strong>Batch:</strong> {extractionResult.currentBatch} / {extractionResult.totalBatches}</p>
                      <p className="text-sm text-yellow-700 mb-3"><strong>Processed:</strong> {extractionResult.processedItems} / {extractionResult.totalItems} items</p>
                      <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div 
                          className="bg-primary h-full transition-all duration-300"
                          style={{ width: `${(extractionResult.processedItems / extractionResult.totalItems) * 100}%` }}
                        ></div>
                      </div>
                      <p className="text-sm text-yellow-700 mt-3">
                        Products Extracted: {extractionResult.productsWithExtraction} | 
                        Requiring Manual Input: {extractionResult.productsRequiringManualInput}
                      </p>
                    </div>
                  )}

                  <div className="flex gap-3 flex-wrap">
                    {!extractionResult && (
                      <button 
                        onClick={() => handleExtractCosts(false)} 
                        disabled={loading || selectedLocations.length === 0}
                        className="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {loading ? 'Extracting Costs...' : 'Extract Costs from Descriptions'}
                      </button>
                    )}
                    {extractionResult && !extractionResult.isComplete && (
                      <>
                        <button 
                          onClick={() => handleExtractCosts(true)} 
                          disabled={loading}
                          className="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {loading ? 'Processing Batch...' : `Continue Extraction Batch ${extractionResult.currentBatch + 1}/${extractionResult.totalBatches}`}
                        </button>
                        <button 
                          onClick={() => setStep('approve')} 
                          disabled={loading}
                          className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          Review Extracted Costs ({extractionResult.processedItems} items)
                        </button>
                      </>
                    )}
                    {extractionResult && extractionResult.isComplete && (
                      <button 
                        onClick={() => setStep('approve')} 
                        disabled={loading}
                        className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        Review & Approve Extracted Costs
                      </button>
                    )}
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  <p className="text-gray-600">
                    Cost extraction is not required for "{costBasis}" cost basis.
                    You can proceed directly to migration.
                  </p>
                  <button 
                    onClick={() => {
                      setStep('migrate');
                      setApprovedCosts({});
                    }} 
                    disabled={loading || selectedLocations.length === 0}
                    className="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Skip Extraction & Proceed to Migration
                  </button>
                </div>
              )}
            </div>
          )}

          {step === 'approve' && extractionResult && (
            <div className="max-w-5xl mx-auto space-y-8">
              <div>
                <h1 className="text-3xl font-bold text-gray-900 mb-6">Review Extracted Costs</h1>
                
                {!extractionResult.isComplete && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-5 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 shadow-sm mb-6">
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <span className="material-icons text-yellow-600 text-3xl">warning</span>
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-yellow-800">Extraction Incomplete</h3>
                        <p className="text-yellow-700 mt-1 max-w-2xl text-sm leading-relaxed">
                          Only <span className="font-bold">{extractionResult.processedItems} of {extractionResult.totalItems}</span> items have been extracted. You can review and approve the extracted costs now, or continue extraction to process remaining items.
                        </p>
                      </div>
                    </div>
                    <button 
                      onClick={() => {
                        setStep('extract');
                        handleExtractCosts(true);
                      }}
                      disabled={loading}
                      className="bg-primary hover:bg-primary-hover text-white px-5 py-2.5 rounded-lg font-medium shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Continue Extraction
                    </button>
                  </div>
                )}

                {/* Tab Navigation */}
                <div className="flex gap-4 mb-6 border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('WITH_EXTRACTION')}
                    className={`px-6 py-3 font-medium text-sm transition-colors border-b-2 ${
                      activeTab === 'WITH_EXTRACTION'
                        ? 'border-green-600 text-green-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    With Extraction
                    <span className="ml-2 text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                      {extractionResult.productsWithExtraction}
                    </span>
                  </button>
                  <button
                    onClick={() => setActiveTab('MANUAL_INPUT')}
                    className={`px-6 py-3 font-medium text-sm transition-colors border-b-2 ${
                      activeTab === 'MANUAL_INPUT'
                        ? 'border-orange-600 text-orange-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    Manual Input
                    <span className="ml-2 text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                      {extractionResult.productsRequiringManualInput}
                    </span>
                  </button>
                  <button
                    onClick={() => setActiveTab('TOTAL_PRODUCTS')}
                    className={`px-6 py-3 font-medium text-sm transition-colors border-b-2 ${
                      activeTab === 'TOTAL_PRODUCTS'
                        ? 'border-blue-600 text-blue-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    Total Products
                    <span className="ml-2 text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
                      {extractionResult.totalProducts}
                    </span>
                  </button>
                  <button
                    disabled
                    className="px-6 py-3 font-medium text-sm text-gray-400 border-b-2 border-transparent cursor-not-allowed opacity-50"
                  >
                    Remaining
                    <span className="ml-2 text-xs font-semibold bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full">
                      {!extractionResult.isComplete ? extractionResult.totalItems - extractionResult.processedItems : 0}
                    </span>
                  </button>
                </div>
              </div>
              
              <div className="space-y-6 max-h-[600px] overflow-y-auto">
                {extractionResult.extractionResults.filter(result => {
                  // Filter based on active tab
                  if (activeTab === 'WITH_EXTRACTION') {
                    // Show only items with extraction
                    return (result.extractedEntries || []).length > 0;
                  } else if (activeTab === 'MANUAL_INPUT') {
                    // Show only items requiring manual input (no extraction)
                    return (result.extractedEntries || []).length === 0;
                  } else if (activeTab === 'TOTAL_PRODUCTS') {
                    // Show all items (both extracted and manual input)
                    return true;
                  }
                  return false;
                }).map(result => {
                  const editedResult = editedExtractionResults[result.productId] || result;
                  // Find the selected entry (the one with isSelected = true)
                  const selectedEntry = editedResult.extractedEntries.find(e => e.isSelected) 
                    || (editedResult.extractedEntries.length > 0 ? editedResult.extractedEntries[editedResult.extractedEntries.length - 1] : null);
                  const selectedSupplierId = editedResult.selectedSupplierId || selectedEntry?.supplierId || null;
                  const selectedSupplierName = editedResult.selectedSupplierName || selectedEntry?.supplier || 'General';
                  const selectedCost = editedResult.selectedCost || result.selectedCost || null;
                  
                  // Extract unique suppliers from extracted entries for dropdown
                  const uniqueSuppliers = [...new Set(
                    editedResult.extractedEntries.map(e => 
                      (e.editedSupplierName !== undefined && e.editedSupplierName !== null) 
                        ? e.editedSupplierName 
                        : (e.supplier || 'General')
                    )
                  )];
                  
                  // Preferred supplier: default to selected option's supplier, but allow independent selection
                  const preferredSupplierName = editedResult.preferredSupplierName !== undefined 
                    ? editedResult.preferredSupplierName 
                    : selectedSupplierName;
                  
                  // Get date from selected entry (user input from selected option)
                  let selectedDate = null;
                  if (selectedEntry) {
                    selectedDate = selectedEntry.editedEffectiveDate || null;
                    // If no edited date, calculate default from extracted month or one week ago
                    if (!selectedDate && selectedEntry.month) {
                      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                      const monthIndex = monthNames.indexOf(selectedEntry.month);
                      if (monthIndex !== -1) {
                        const now = new Date();
                        const currentYear = now.getFullYear();
                        const currentMonth = now.getMonth();
                        const year = monthIndex > currentMonth ? currentYear - 1 : currentYear;
                        const extractedDate = new Date(year, monthIndex, 1);
                        selectedDate = extractedDate.toISOString().split('T')[0];
                      }
                    }
                    if (!selectedDate) {
                      // Default: one week ago
                      const defaultDate = new Date();
                      defaultDate.setDate(defaultDate.getDate() - 7);
                      selectedDate = defaultDate.toISOString().split('T')[0];
                    }
                  }
                  
                  // Split product name into main name and brand (last 1-2 words as brand)
                  const splitProductName = (name) => {
                    if (!name) return { main: '', brand: '' };
                    const words = name.trim().split(/\s+/);
                    if (words.length <= 1) return { main: name, brand: '' };
                    // If 2-3 words, use last word as brand
                    if (words.length <= 3) {
                      return { main: words.slice(0, -1).join(' '), brand: words[words.length - 1] };
                    }
                    // For longer names, use last 2 words as brand
                    return { main: words.slice(0, -2).join(' '), brand: words.slice(-2).join(' ') };
                  };
                  const { main: productMainName, brand: productBrand } = splitProductName(result.productName);

                  return (
                    <div key={result.productId} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      {editedResult.extractedEntries.length > 0 ? (
                        <div className="p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                          <div className="lg:col-span-4 space-y-5">
                            {/* Product Image */}
                            <div className="w-full bg-gray-200 rounded-lg flex items-center justify-center relative" style={{ height: '200px', minHeight: '200px' }}>
                              {result.imageUrl ? (
                                <>
                                  <img 
                                    src={result.imageUrl} 
                                    alt={result.productName}
                                    className="w-full h-full object-cover rounded-lg"
                                    onError={(e) => {
                                      // Hide image and show placeholder if image fails to load
                                      e.target.style.display = 'none';
                                      const placeholder = e.target.parentElement?.querySelector('.image-placeholder');
                                      if (placeholder) {
                                        placeholder.style.display = 'flex';
                                      }
                                    }}
                                  />
                                  <div className="image-placeholder absolute inset-0 w-full h-full bg-gray-200 rounded-lg flex items-center justify-center" style={{ display: 'none' }}>
                                    <div className="text-center">
                                      <span className="material-icons text-gray-400 text-6xl">image</span>
                                      <p className="text-xs text-gray-500 mt-2">No Product Image</p>
                                    </div>
                                  </div>
                                </>
                              ) : (
                                <div className="text-center">
                                  <span className="material-icons text-gray-400 text-6xl">image</span>
                                  <p className="text-xs text-gray-500 mt-2">No Product Image</p>
                                </div>
                              )}
                            </div>
                            
                            {/* Product Name - Two Lines */}
                            <div>
                              <h2 className="text-xl font-bold text-gray-900">{productMainName}</h2>
                              {productBrand && <p className="text-xl font-bold text-gray-900">{productBrand}</p>}
                            </div>
                            
                            {/* Separator instead of "SELECTED VALUES" heading */}
                            <div className="border-t border-gray-200 my-4"></div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Supplier Name</label>
                              <input 
                                className="block w-full rounded-md border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" 
                                readOnly 
                                type="text" 
                                value={selectedSupplierName || 'N/A'}
                              />
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Cost</label>
                              <div className="relative rounded-md shadow-sm">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                  <span className="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input 
                                  className="block w-full rounded-md border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" 
                                  style={{ paddingLeft: '21px' }}
                                  readOnly 
                                  type="text" 
                                  value={selectedCost !== null && selectedCost !== undefined ? selectedCost.toFixed(2) : 'N/A'}
                                />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Preferred Supplier</label>
                              <select
                                className="block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                                value={preferredSupplierName || 'General'}
                                onChange={(e) => {
                                  const newResults = { ...editedExtractionResults };
                                  if (!newResults[result.productId]) {
                                    newResults[result.productId] = { ...result };
                                  }
                                  newResults[result.productId].preferredSupplierName = e.target.value;
                                  setEditedExtractionResults(newResults);
                                }}
                              >
                                {uniqueSuppliers.map((supplier, idx) => (
                                  <option key={idx} value={supplier}>{supplier}</option>
                                ))}
                              </select>
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Cost History Date</label>
                              <input 
                                className="block w-full rounded-md border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" 
                                readOnly 
                                type="text" 
                                value={selectedDate ? (() => {
                                  // Parse date string (format: YYYY-MM-DD or MM/DD/YYYY)
                                  // Always parse as local time to avoid timezone issues
                                  let date;
                                  if (selectedDate.includes('/')) {
                                    // Handle MM/DD/YYYY format
                                    const parts = selectedDate.split('/');
                                    const month = parseInt(parts[0], 10) - 1; // JavaScript months are 0-indexed
                                    const day = parseInt(parts[1], 10);
                                    const year = parseInt(parts[2], 10);
                                    date = new Date(year, month, day);
                                  } else {
                                    // Handle YYYY-MM-DD format (ISO) - parse as local time, not UTC
                                    const parts = selectedDate.split('-');
                                    const year = parseInt(parts[0], 10);
                                    const month = parseInt(parts[1], 10) - 1; // JavaScript months are 0-indexed
                                    const day = parseInt(parts[2], 10);
                                    date = new Date(year, month, day);
                                  }
                                  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                  return monthNames[date.getMonth()];
                                })() : 'N/A'}
                              />
                            </div>
                          </div>

                          <div className="lg:col-span-8 space-y-4">
                            <div className="flex items-center justify-between mb-2">
                              <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-wider">Extracted Options</h3>
                              <span className="text-xs text-gray-500">Select the correct extraction below</span>
                            </div>
                            <div className="space-y-3">
                              {editedResult.extractedEntries.map((entry, idx) => {
                                const editedEntry = editedResult.extractedEntries[idx];
                                const isSelected = editedEntry.isSelected !== undefined ? editedEntry.isSelected : (idx === editedResult.extractedEntries.length - 1);
                                const entrySupplierName = editedEntry.editedSupplierName !== undefined && editedEntry.editedSupplierName !== null 
                                  ? editedEntry.editedSupplierName 
                                  : (entry.supplier || 'General');
                                const entryCost = editedEntry.editedCost !== null && editedEntry.editedCost !== undefined ? editedEntry.editedCost : entry.amount;
                                
                                // Calculate default date: use extracted month if available, otherwise one week ago
                                let defaultDateString;
                                if (entry.month) {
                                  // Convert month name to date (use first day of that month)
                                  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                                  const monthIndex = monthNames.indexOf(entry.month);
                                  if (monthIndex !== -1) {
                                    const now = new Date();
                                    const currentYear = now.getFullYear();
                                    const currentMonth = now.getMonth();
                                    // Use the extracted month, first day of month
                                    // If the extracted month is later in the year than current month, use previous year
                                    const year = monthIndex > currentMonth ? currentYear - 1 : currentYear;
                                    const extractedDate = new Date(year, monthIndex, 1);
                                    defaultDateString = extractedDate.toISOString().split('T')[0];
                                  } else {
                                    // Fallback: one week ago
                                    const defaultDate = new Date();
                                    defaultDate.setDate(defaultDate.getDate() - 7);
                                    defaultDateString = defaultDate.toISOString().split('T')[0];
                                  }
                                } else {
                                  // Default date: one week ago
                                  const defaultDate = new Date();
                                  defaultDate.setDate(defaultDate.getDate() - 7);
                                  defaultDateString = defaultDate.toISOString().split('T')[0];
                                }
                                
                                const entryDate = editedEntry.editedEffectiveDate || defaultDateString;
                                const entryAddToHistory = editedEntry.addToHistory !== undefined ? editedEntry.addToHistory : true;
                                
                                // Format date for display
                                const displayDate = entryDate ? (() => {
                                  let date;
                                  if (entryDate.includes('/')) {
                                    const parts = entryDate.split('/');
                                    const month = parseInt(parts[0], 10) - 1;
                                    const day = parseInt(parts[1], 10);
                                    const year = parseInt(parts[2], 10);
                                    date = new Date(year, month, day);
                                  } else {
                                    const parts = entryDate.split('-');
                                    const year = parseInt(parts[0], 10);
                                    const month = parseInt(parts[1], 10) - 1;
                                    const day = parseInt(parts[2], 10);
                                    date = new Date(year, month, day);
                                  }
                                  const monthNames = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                                  const dayNames = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31'];
                                  return `${monthNames[date.getMonth()]}/${dayNames[date.getDate() - 1]}/${date.getFullYear()}`;
                                })() : '';
                                
                                // Confidence badge styling
                                const confidenceClass = entry.confidence === 'HIGH' 
                                  ? 'text-green-600 border-green-200 bg-green-50' 
                                  : entry.confidence === 'MEDIUM'
                                  ? 'text-gray-500 border-gray-200'
                                  : 'text-orange-600 border-orange-200 bg-orange-50';
                                
                                return (
                                  <div 
                                    key={idx} 
                                    className={`relative border rounded-lg p-4 transition-colors cursor-pointer group ${
                                      isSelected 
                                        ? 'border-2 border-primary bg-blue-50/50 shadow-sm ring-1 ring-primary/10' 
                                        : 'border-gray-200 bg-white hover:bg-gray-50'
                                    }`}
                                  >
                                    {isSelected && (
                                      <div className="absolute top-0 left-0 w-full h-1 bg-primary rounded-t-lg"></div>
                                    )}
                                    {!isSelected && (
                                      <div className="absolute top-0 left-0 w-full h-1 bg-gray-200 rounded-t-lg group-hover:bg-gray-300 transition-colors"></div>
                                    )}
                                    <div className="flex items-start gap-4">
                                      <div className="pt-1 flex flex-col items-center gap-1">
                                        <input
                                          type="radio"
                                          name={`selected_${result.productId}`}
                                          checked={isSelected}
                                          onChange={() => {
                                            const newResults = { ...editedExtractionResults };
                                            if (!newResults[result.productId]) {
                                              newResults[result.productId] = { ...result };
                                            }
                                            if (!newResults[result.productId].extractedEntries) {
                                              newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                            }
                                            // Unselect all entries for this product
                                            newResults[result.productId].extractedEntries = newResults[result.productId].extractedEntries.map((e, i) => ({
                                              ...e,
                                              isSelected: i === idx,
                                            }));
                                            // Update selected cost and supplier
                                            newResults[result.productId].selectedCost = entryCost;
                                            newResults[result.productId].selectedSupplierName = entrySupplierName;
                                            newResults[result.productId].selectedSupplierId = editedEntry.supplierId || null;
                                            setEditedExtractionResults(newResults);
                                          }}
                                          className="h-4 w-4 text-primary border-gray-300 focus:ring-primary"
                                        />
                                        {isSelected && <span className="material-icons text-primary text-sm font-bold">check</span>}
                                      </div>
                                      <div className="flex-1 space-y-3">
                                        <div className="flex items-center justify-between">
                                          <div className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-mono">
                                            Original: {entry.originalLine}
                                          </div>
                                          <div className="flex items-center gap-2">
                                            <input
                                              type="checkbox"
                                              checked={entryAddToHistory}
                                              onChange={(e) => {
                                                const newResults = { ...editedExtractionResults };
                                                if (!newResults[result.productId]) {
                                                  newResults[result.productId] = { ...result };
                                                }
                                                if (!newResults[result.productId].extractedEntries[idx]) {
                                                  newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                                }
                                                newResults[result.productId].extractedEntries[idx] = {
                                                  ...newResults[result.productId].extractedEntries[idx],
                                                  addToHistory: e.target.checked,
                                                };
                                                setEditedExtractionResults(newResults);
                                              }}
                                              className="h-3 w-3 rounded text-primary border-gray-300 focus:ring-primary"
                                            />
                                            <span className="text-xs font-medium text-gray-500">History</span>
                                          </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                                          <div className="md:col-span-6 space-y-1">
                                            <label className="text-xs text-gray-500">Supplier</label>
                                            <div className="relative autocomplete-container">
                                              <input
                                                type="text"
                                                value={entrySupplierName}
                                                onChange={(e) => {
                                                  const inputValue = e.target.value;
                                                  const originalSupplierName = entry.supplier;
                                                  const newSupplierName = inputValue;
                                                  
                                                  // Update state with the input value (no auto-select when typing)
                                                  setEditedExtractionResults(prevResults => {
                                                    const newResults = { ...prevResults };
                                                    if (!newResults[result.productId]) {
                                                      newResults[result.productId] = { ...result };
                                                    }
                                                    if (!newResults[result.productId].extractedEntries) {
                                                      newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                                    }
                                                    if (!newResults[result.productId].extractedEntries[idx]) {
                                                      newResults[result.productId].extractedEntries[idx] = { ...result.extractedEntries[idx] };
                                                    }
                                                    newResults[result.productId].extractedEntries[idx] = {
                                                      ...newResults[result.productId].extractedEntries[idx],
                                                      editedSupplierName: newSupplierName,
                                                      supplierId: null,
                                                    };
                                                    if (isSelected) {
                                                      newResults[result.productId].selectedSupplierName = newSupplierName;
                                                      newResults[result.productId].selectedSupplierId = null;
                                                    }
                                                    return newResults;
                                                  });
                                                  
                                                  // Update supplier name mapping if name changed
                                                  // DO NOT track mappings for Unknown/General/null suppliers
                                                  const isUnknownOrGeneral = !originalSupplierName || originalSupplierName === 'Unknown' || originalSupplierName === 'General';
                                                  
                                                  if (!isUnknownOrGeneral && newSupplierName !== originalSupplierName && newSupplierName.trim() !== '') {
                                                    setSupplierNameMappings(prev => {
                                                      // Remove existing mapping for this original name if it exists
                                                      const filtered = prev.filter(m => m.supplierOriginal !== originalSupplierName);
                                                      // Add or update the mapping
                                                      return [...filtered, { supplierOriginal: originalSupplierName, new: newSupplierName }];
                                                    });
                                                  }
                                                  
                                                  if (inputValue.length > 0) {
                                                    // First, try local matching (initials, mappings, names)
                                                    const localSuggestions = getSupplierSuggestions(inputValue, originalSupplierName);
                                                    
                                                    if (localSuggestions.length > 0) {
                                                      setOpenAutocomplete(prev => ({ ...prev, [`${result.productId}_${idx}`]: true }));
                                                      setSupplierSuggestions(prev => ({
                                                        ...prev,
                                                        [`${result.productId}_${idx}`]: localSuggestions
                                                      }));
                                                    } else if (inputValue.length > 1) {
                                                      // Fallback to API call if no local matches
                                                      setOpenAutocomplete(prev => ({ ...prev, [`${result.productId}_${idx}`]: true }));
                                                      fetch(`/admin/inventory/cutover/suppliers/suggest?q=${encodeURIComponent(inputValue)}`)
                                                        .then(res => res.json())
                                                        .then(data => {
                                                          if (data.success) {
                                                            setSupplierSuggestions(prev => ({
                                                              ...prev,
                                                              [`${result.productId}_${idx}`]: data.suppliers
                                                            }));
                                                          }
                                                        })
                                                        .catch(err => console.error('Failed to fetch suggestions:', err));
                                                    } else {
                                                      setOpenAutocomplete(prev => {
                                                        const newState = { ...prev };
                                                        delete newState[`${result.productId}_${idx}`];
                                                        return newState;
                                                      });
                                                    }
                                                  } else {
                                                    setOpenAutocomplete(prev => {
                                                      const newState = { ...prev };
                                                      delete newState[`${result.productId}_${idx}`];
                                                      return newState;
                                                    });
                                                  }
                                                }}
                                                className={`block w-full rounded-md border shadow-sm focus:border-primary focus:ring-primary sm:text-sm ${
                                                  isSelected 
                                                    ? 'border-primary bg-white' 
                                                    : 'border-gray-300 bg-white'
                                                }`}
                                              />
                                              {openAutocomplete[`${result.productId}_${idx}`] && supplierSuggestions[`${result.productId}_${idx}`] && supplierSuggestions[`${result.productId}_${idx}`].length > 0 && (
                                                <div className="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md mt-1 z-50 max-h-32 overflow-y-auto shadow-lg">
                                                  {supplierSuggestions[`${result.productId}_${idx}`].map((supplier, suggestionIdx) => (
                                                    <div
                                                      key={supplier.id || `suggestion-${suggestionIdx}`}
                                                      onClick={() => {
                                                        const originalSupplierName = entry.supplier;
                                                        const newSupplierName = supplier.name;
                                                        
                                                        const newResults = { ...editedExtractionResults };
                                                        if (!newResults[result.productId]) {
                                                          newResults[result.productId] = { ...result };
                                                        }
                                                        if (!newResults[result.productId].extractedEntries[idx]) {
                                                          newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                                        }
                                                        newResults[result.productId].extractedEntries[idx] = {
                                                          ...newResults[result.productId].extractedEntries[idx],
                                                          supplierId: supplier.id,
                                                          editedSupplierName: supplier.name,
                                                        };
                                                        if (isSelected) {
                                                          newResults[result.productId].selectedSupplierName = supplier.name;
                                                          newResults[result.productId].selectedSupplierId = supplier.id;
                                                        }
                                                        setEditedExtractionResults(newResults);
                                                        
                                                        // Update supplier name mapping if name changed
                                                        // DO NOT track mappings for Unknown/General/null suppliers
                                                        const isUnknownOrGeneral = !originalSupplierName || originalSupplierName === 'Unknown' || originalSupplierName === 'General';
                                                        
                                                        if (!isUnknownOrGeneral && newSupplierName !== originalSupplierName && newSupplierName.trim() !== '') {
                                                          setSupplierNameMappings(prev => {
                                                            // Remove existing mapping for this original name if it exists
                                                            const filtered = prev.filter(m => m.supplierOriginal !== originalSupplierName);
                                                            // Add or update the mapping
                                                            return [...filtered, { supplierOriginal: originalSupplierName, new: newSupplierName }];
                                                          });
                                                        }
                                                        setOpenAutocomplete(prev => {
                                                          const newState = { ...prev };
                                                          delete newState[`${result.productId}_${idx}`];
                                                          return newState;
                                                        });
                                                        setSupplierSuggestions(prev => {
                                                          const newSuggestions = { ...prev };
                                                          delete newSuggestions[`${result.productId}_${idx}`];
                                                          return newSuggestions;
                                                        });
                                                      }}
                                                      className="px-3 py-2 cursor-pointer border-b border-gray-100 text-sm hover:bg-gray-50"
                                                    >
                                                      {supplier.name}
                                                    </div>
                                                  ))}
                                                </div>
                                              )}
                                            </div>
                                          </div>
                                          <div className="md:col-span-3 space-y-1">
                                            <label className="text-xs text-gray-500">Cost</label>
                                            <div className="relative rounded-md shadow-sm">
                                              <input
                                                type="number"
                                                step="0.01"
                                                value={entryCost}
                                                onChange={(e) => {
                                                  const newResults = { ...editedExtractionResults };
                                                  if (!newResults[result.productId]) {
                                                    newResults[result.productId] = { ...result };
                                                  }
                                                  if (!newResults[result.productId].extractedEntries[idx]) {
                                                    newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                                  }
                                                  const newCost = parseFloat(e.target.value) || null;
                                                  newResults[result.productId].extractedEntries[idx] = {
                                                    ...newResults[result.productId].extractedEntries[idx],
                                                    editedCost: newCost,
                                                  };
                                                  if (isSelected) {
                                                    newResults[result.productId].selectedCost = newCost;
                                                  }
                                                  setEditedExtractionResults(newResults);
                                                }}
                                                className={`block w-full rounded-md border pr-8 shadow-sm focus:border-primary focus:ring-primary sm:text-sm text-right ${
                                                  isSelected 
                                                    ? 'border-primary bg-white font-medium' 
                                                    : 'border-gray-300 bg-white'
                                                }`}
                                              />
                                              <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <span className="material-icons text-gray-400 text-xs">unfold_more</span>
                                              </div>
                                            </div>
                                          </div>
                                          <div className="md:col-span-3 space-y-1">
                                            <label className="text-xs text-gray-500">Date</label>
                                            <input
                                              type="date"
                                              value={entryDate}
                                              onChange={(e) => {
                                                const newResults = { ...editedExtractionResults };
                                                if (!newResults[result.productId]) {
                                                  newResults[result.productId] = { ...result };
                                                }
                                                if (!newResults[result.productId].extractedEntries[idx]) {
                                                  newResults[result.productId].extractedEntries = [...result.extractedEntries];
                                                }
                                                newResults[result.productId].extractedEntries[idx] = {
                                                  ...newResults[result.productId].extractedEntries[idx],
                                                  editedEffectiveDate: e.target.value,
                                                };
                                                setEditedExtractionResults(newResults);
                                              }}
                                              className={`block w-full rounded-md border shadow-sm focus:border-primary focus:ring-primary sm:text-sm text-center ${
                                                isSelected 
                                                  ? 'border-primary bg-white' 
                                                  : 'border-gray-300 bg-white'
                                              }`}
                                            />
                                          </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                          <span className={`text-xs font-semibold border px-1.5 py-0.5 rounded uppercase ${confidenceClass}`}>
                                            {entry.confidence} Confidence
                                          </span>
                                          {entry.month && (
                                            <span className="text-xs text-gray-500">Month extracted: {entry.month}</span>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div className="p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                          <div className="lg:col-span-4 space-y-5">
                            {/* Product Image */}
                            <div className="w-full bg-gray-200 rounded-lg flex items-center justify-center relative" style={{ height: '200px', minHeight: '200px' }}>
                              {result.imageUrl ? (
                                <>
                                  <img 
                                    src={result.imageUrl} 
                                    alt={result.productName}
                                    className="w-full h-full object-cover rounded-lg"
                                    onError={(e) => {
                                      // Hide image and show placeholder if image fails to load
                                      e.target.style.display = 'none';
                                      const placeholder = e.target.parentElement?.querySelector('.image-placeholder');
                                      if (placeholder) {
                                        placeholder.style.display = 'flex';
                                      }
                                    }}
                                  />
                                  <div className="image-placeholder absolute inset-0 w-full h-full bg-gray-200 rounded-lg flex items-center justify-center" style={{ display: 'none' }}>
                                    <div className="text-center">
                                      <span className="material-icons text-gray-400 text-6xl">image</span>
                                      <p className="text-xs text-gray-500 mt-2">No Product Image</p>
                                    </div>
                                  </div>
                                </>
                              ) : (
                                <div className="text-center">
                                  <span className="material-icons text-gray-400 text-6xl">image</span>
                                  <p className="text-xs text-gray-500 mt-2">No Product Image</p>
                                </div>
                              )}
                            </div>
                            
                            {/* Product Name - Two Lines */}
                            <div>
                              <h2 className="text-xl font-bold text-gray-900">{productMainName}</h2>
                              {productBrand && <p className="text-xl font-bold text-gray-900">{productBrand}</p>}
                            </div>
                            
                            {/* Separator */}
                            <div className="border-t border-gray-200 my-4"></div>
                            
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Supplier Name</label>
                              <div className="relative autocomplete-container">
                                <input
                                  type="text"
                                  value={editedResult.selectedSupplierName || ''}
                                  onChange={(e) => {
                                    const inputValue = e.target.value;
                                    const originalSupplierName = result.selectedSupplierName;
                                    const newSupplierName = inputValue;
                                    
                                    // Update state with the input value (no auto-select for manual input)
                                    setEditedExtractionResults(prevResults => {
                                      const newResults = { ...prevResults };
                                      if (!newResults[result.productId]) {
                                        newResults[result.productId] = { ...result };
                                      }
                                      newResults[result.productId].selectedSupplierName = newSupplierName;
                                      newResults[result.productId].selectedSupplierId = null;
                                      return newResults;
                                    });
                                    
                                    // Update supplier name mapping if name changed
                                    // DO NOT track mappings for Unknown/General/null suppliers
                                    const isUnknownOrGeneral = !originalSupplierName || originalSupplierName === 'Unknown' || originalSupplierName === 'General';
                                    
                                    if (!isUnknownOrGeneral && newSupplierName !== originalSupplierName && newSupplierName.trim() !== '') {
                                      setSupplierNameMappings(prev => {
                                        // Remove existing mapping for this original name if it exists
                                        const filtered = prev.filter(m => m.supplierOriginal !== originalSupplierName);
                                        // Add or update the mapping
                                        return [...filtered, { supplierOriginal: originalSupplierName, new: newSupplierName }];
                                      });
                                    }
                                    
                                    if (inputValue.length > 0) {
                                      // First, try local matching (initials, mappings, names)
                                      const localSuggestions = getSupplierSuggestions(inputValue, originalSupplierName);
                                      
                                      if (localSuggestions.length > 0) {
                                        setOpenAutocomplete(prev => ({ ...prev, [result.productId]: true }));
                                        setSupplierSuggestions(prev => ({
                                          ...prev,
                                          [result.productId]: localSuggestions
                                        }));
                                      } else if (inputValue.length > 1) {
                                        // Fallback to API call if no local matches
                                        setOpenAutocomplete(prev => ({ ...prev, [result.productId]: true }));
                                        fetch(`/admin/inventory/cutover/suppliers/suggest?q=${encodeURIComponent(inputValue)}`)
                                          .then(res => res.json())
                                          .then(data => {
                                            if (data.success) {
                                              setSupplierSuggestions(prev => ({
                                                ...prev,
                                                [result.productId]: data.suppliers
                                              }));
                                            }
                                          })
                                          .catch(err => console.error('Failed to fetch suggestions:', err));
                                      } else {
                                        setOpenAutocomplete(prev => {
                                          const newState = { ...prev };
                                          delete newState[result.productId];
                                          return newState;
                                        });
                                      }
                                    } else if (inputValue.length === 0) {
                                      setOpenAutocomplete(prev => {
                                        const newState = { ...prev };
                                        delete newState[result.productId];
                                        return newState;
                                      });
                                    }
                                  }}
                                  onFocus={() => {
                                    if (supplierSuggestions[result.productId] && supplierSuggestions[result.productId].length > 0) {
                                      setOpenAutocomplete(prev => ({ ...prev, [result.productId]: true }));
                                    }
                                  }}
                                  placeholder="Enter supplier name"
                                  className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white"
                                />
                                {openAutocomplete[result.productId] && supplierSuggestions[result.productId] && supplierSuggestions[result.productId].length > 0 && (
                                  <div className="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md mt-1 z-50 max-h-48 overflow-y-auto shadow-lg">
                                    {supplierSuggestions[result.productId].map((supplier, suggestionIdx) => (
                                      <div
                                        key={supplier.id || `suggestion-${suggestionIdx}`}
                                        onClick={() => {
                                          const originalSupplierName = result.selectedSupplierName;
                                          const newSupplierName = supplier.name;
                                          
                                          const newResults = { ...editedExtractionResults };
                                          if (!newResults[result.productId]) {
                                            newResults[result.productId] = { ...result };
                                          }
                                          newResults[result.productId].selectedSupplierId = supplier.id;
                                          newResults[result.productId].selectedSupplierName = supplier.name;
                                          setEditedExtractionResults(newResults);
                                          
                                          // Update supplier name mapping if name changed
                                          // DO NOT track mappings for Unknown/General/null suppliers
                                          const isUnknownOrGeneral = !originalSupplierName || originalSupplierName === 'Unknown' || originalSupplierName === 'General';
                                          
                                          if (!isUnknownOrGeneral && newSupplierName !== originalSupplierName && newSupplierName.trim() !== '') {
                                            setSupplierNameMappings(prev => {
                                              // Remove existing mapping for this original name if it exists
                                              const filtered = prev.filter(m => m.supplierOriginal !== originalSupplierName);
                                              // Add or update the mapping
                                              return [...filtered, { supplierOriginal: originalSupplierName, new: newSupplierName }];
                                            });
                                          }
                                          setOpenAutocomplete(prev => {
                                            const newState = { ...prev };
                                            delete newState[result.productId];
                                            return newState;
                                          });
                                          setSupplierSuggestions(prev => {
                                            const newSuggestions = { ...prev };
                                            delete newSuggestions[result.productId];
                                            return newSuggestions;
                                          });
                                        }}
                                        className="px-3 py-2 cursor-pointer border-b border-gray-100 hover:bg-gray-50"
                                      >
                                        {supplier.name}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Cost</label>
                              <div className="relative rounded-md shadow-sm">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                  <span className="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={editedResult.selectedCost || ''}
                                  onChange={(e) => {
                                    const newResults = { ...editedExtractionResults };
                                    if (!newResults[result.productId]) {
                                      newResults[result.productId] = { ...result };
                                    }
                                    newResults[result.productId].selectedCost = parseFloat(e.target.value) || null;
                                    setEditedExtractionResults(newResults);
                                  }}
                                  placeholder="0.00"
                                  style={{ paddingLeft: '21px' }}
                                  className="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white"
                                />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Preferred Supplier</label>
                              <input 
                                className="block w-full rounded-md border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" 
                                readOnly 
                                type="text" 
                                value={editedResult.selectedSupplierName || 'N/A'}
                              />
                            </div>
                            <div className="space-y-1">
                              <label className="block text-xs font-medium text-gray-500 uppercase">Cost History Date</label>
                              <input 
                                className="block w-full rounded-md border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" 
                                readOnly 
                                type="text" 
                                value="N/A"
                              />
                            </div>
                          </div>
                          <div className="lg:col-span-8">
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                              <div className="flex items-start justify-between gap-4">
                                <div>
                                  <p className="text-sm text-red-800 font-medium mb-2">No cost extracted - manual input required</p>
                                  <p className="text-xs text-red-600">Please enter the supplier name and cost above.</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
                {!extractionResult.isComplete && (
                  <button 
                    onClick={() => {
                      handleExtractCosts(true);
                    }}
                    disabled={loading}
                    className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? 'Processing Batch...' : `Continue Extraction Batch ${extractionResult.currentBatch + 1}/${extractionResult.totalBatches}`}
                  </button>
                )}
                <button 
                  onClick={handleApproveCosts} 
                  disabled={loading} 
                  className="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Approving...' : extractionResult.isComplete ? 'Approve All Costs' : `Approve Extracted Costs (${extractionResult.processedItems} items)`}
                </button>
              </div>
            </div>
          )}

          {step === 'migrate' && (
            <div className="space-y-6">
              <div>
                <h3 className="text-xl font-bold text-gray-900 mb-2">Ready to Migrate</h3>
                <p className="text-gray-600">Costs have been approved. You can preview the migration or proceed directly.</p>
              </div>
              
              {migrationResult && !migrationResult.isComplete && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <h4 className="font-semibold text-yellow-800 mb-2">Batch Progress</h4>
                  <p className="text-sm text-yellow-700 mb-1"><strong>Batch:</strong> {migrationResult.currentBatch} / {migrationResult.totalBatches}</p>
                  <p className="text-sm text-yellow-700 mb-3"><strong>Processed:</strong> {migrationResult.processedItems} / {migrationResult.totalItems} items</p>
                  <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div 
                      className="bg-green-600 h-full transition-all duration-300"
                      style={{ width: `${(migrationResult.processedItems / migrationResult.totalItems) * 100}%` }}
                    ></div>
                  </div>
                  <p className="text-sm text-yellow-700 mt-3">
                    Products Processed: {migrationResult.productsProcessed} | 
                    Opening Balances Created: {migrationResult.openingBalancesCreated}
                  </p>
                  {migrationResult.errors.length > 0 && (
                    <div className="mt-3 p-3 bg-white rounded border border-yellow-300">
                      <strong className="text-yellow-800">Errors:</strong> <span className="text-yellow-700">{migrationResult.errors.length}</span>
                    </div>
                  )}
                </div>
              )}
              
              <div className="flex gap-3">
                {!migrationResult && (
                  <>
                    <button 
                      onClick={handlePreview} 
                      disabled={loading}
                      className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {loading ? 'Previewing...' : 'Preview Migration'}
                    </button>
                    <button 
                      onClick={() => handleMigrate(false)} 
                      disabled={loading}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {loading ? 'Migrating...' : 'Execute Migration'}
                    </button>
                  </>
                )}
                {migrationResult && !migrationResult.isComplete && (
                  <button 
                    onClick={() => handleMigrate(true)} 
                    disabled={loading}
                    className="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? 'Processing Batch...' : `Continue Batch ${migrationResult.currentBatch + 1}/${migrationResult.totalBatches}`}
                  </button>
                )}
              </div>

              {previewResult && (
                <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <h4 className="font-semibold text-gray-900 mb-3">Preview Results</h4>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="text-gray-600">Total Products:</span>
                      <span className="ml-2 font-semibold text-gray-900">{previewResult.totalProducts}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Products with Cost:</span>
                      <span className="ml-2 font-semibold text-green-600">{previewResult.productsWithCost}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Products Missing Cost:</span>
                      <span className="ml-2 font-semibold text-orange-600">{previewResult.productsMissingCost}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Estimated Opening Balances:</span>
                      <span className="ml-2 font-semibold text-gray-900">{previewResult.estimatedOpeningBalances}</span>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {step === 'complete' && migrationResult && (
            <div className="bg-green-50 border border-green-200 rounded-lg p-6 text-green-800">
              <h3 className="text-xl font-bold mb-4">Migration Completed Successfully!</h3>
              <div className="space-y-2 text-sm">
                <p><strong>Cutover Date:</strong> {new Date(migrationResult.cutoverDate).toLocaleString()}</p>
                <p><strong>Locations Processed:</strong> {migrationResult.locationsProcessed}</p>
                <p><strong>Products Processed:</strong> {migrationResult.productsProcessed}</p>
                <p><strong>Opening Balances Created:</strong> {migrationResult.openingBalancesCreated}</p>
                {migrationResult.batchSize && (
                  <p><strong>Processed in:</strong> {migrationResult.totalBatches} batch(es) of {migrationResult.batchSize} items</p>
                )}
                {migrationResult.errors.length > 0 && (
                  <div className="mt-4 p-3 bg-white rounded border border-green-300">
                    <strong className="text-green-800">Errors:</strong>
                    <ul className="mt-2 list-disc list-inside">
                      {migrationResult.errors.map((err, idx) => (
                        <li key={idx} className="text-green-700">{err.message}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    function Suppliers() {
      const [suppliers, setSuppliers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [formData, setFormData] = useState({ name: '', initials: '', contactInfo: '', isActive: true });
      const [showAddForm, setShowAddForm] = useState(false);
      const [filterActive, setFilterActive] = useState(true);

      const fetchSuppliers = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/admin/inventory/cutover/suppliers');
          const data = await response.json();
          if (data.success) {
            setSuppliers(data.suppliers);
          } else {
            setError(data.message || 'Failed to fetch suppliers');
          }
        } catch (err) {
          setError(err.message || 'Failed to fetch suppliers');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        fetchSuppliers();
      }, []);

      const handleCreate = async () => {
        if (!formData.name.trim()) {
          setError('Supplier name is required');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/admin/inventory/cutover/suppliers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: formData.name.trim(),
              initials: formData.initials.trim() || null,
              contactInfo: formData.contactInfo.trim() || null,
            }),
          });
          const data = await response.json();
          if (data.success) {
            await fetchSuppliers();
            setFormData({ name: '', initials: '', contactInfo: '', isActive: true });
            setShowAddForm(false);
          } else {
            setError(data.message || 'Failed to create supplier');
          }
        } catch (err) {
          setError(err.message || 'Failed to create supplier');
        } finally {
          setLoading(false);
        }
      };

      const handleUpdate = async (id) => {
        if (!formData.name.trim()) {
          setError('Supplier name is required');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(`/admin/inventory/cutover/suppliers/${id}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: formData.name.trim(),
              initials: formData.initials.trim() || null,
              contactInfo: formData.contactInfo.trim() || null,
              isActive: formData.isActive,
            }),
          });
          const data = await response.json();
          if (data.success) {
            await fetchSuppliers();
            setEditingId(null);
            setFormData({ name: '', initials: '', contactInfo: '', isActive: true });
          } else {
            setError(data.message || 'Failed to update supplier');
          }
        } catch (err) {
          setError(err.message || 'Failed to update supplier');
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Are you sure you want to deactivate this supplier?')) {
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(`/admin/inventory/cutover/suppliers/${id}/delete`, {
            method: 'POST',
          });
          const data = await response.json();
          if (data.success) {
            await fetchSuppliers();
          } else {
            setError(data.message || 'Failed to delete supplier');
          }
        } catch (err) {
          setError(err.message || 'Failed to delete supplier');
        } finally {
          setLoading(false);
        }
      };

      const startEdit = (supplier) => {
        setEditingId(supplier.id);
        setFormData({
          name: supplier.name,
          initials: supplier.initials || '',
          contactInfo: supplier.contactInfo || '',
          isActive: supplier.isActive,
        });
        setShowAddForm(false);
      };

      const cancelEdit = () => {
        setEditingId(null);
        setFormData({ name: '', initials: '', contactInfo: '', isActive: true });
        setShowAddForm(false);
      };

      const filteredSuppliers = filterActive 
        ? suppliers.filter(s => s.isActive)
        : suppliers;

      return (
        <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-sm p-6">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-900">Supplier Management</h2>
            <div className="flex gap-3">
              <button
                onClick={() => setFilterActive(!filterActive)}
                className={`px-4 py-2 rounded-md text-sm font-medium ${
                  filterActive
                    ? 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    : 'bg-primary text-white hover:bg-primary-hover'
                }`}
              >
                {filterActive ? 'Show All' : 'Show Active Only'}
              </button>
              <button
                onClick={() => {
                  cancelEdit();
                  setShowAddForm(true);
                }}
                className="px-4 py-2 bg-primary text-white rounded-md text-sm font-medium hover:bg-primary-hover"
                disabled={loading || editingId}
              >
                + Add Supplier
              </button>
            </div>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
              {error}
            </div>
          )}

          {(showAddForm || editingId) && (
            <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                {editingId ? 'Edit Supplier' : 'Add New Supplier'}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Supplier Name <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., Levi Pharmaceuticals"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Initials/Abbreviation
                  </label>
                  <input
                    type="text"
                    value={formData.initials}
                    onChange={(e) => setFormData({ ...formData, initials: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="e.g., L (for cost extraction)"
                    maxLength={10}
                  />
                  <p className="mt-1 text-xs text-gray-500">Used for cost extraction from product descriptions</p>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Contact Info
                  </label>
                  <input
                    type="text"
                    value={formData.contactInfo}
                    onChange={(e) => setFormData({ ...formData, contactInfo: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Email, phone, or address"
                  />
                </div>
                {editingId && (
                  <div>
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={formData.isActive}
                        onChange={(e) => setFormData({ ...formData, isActive: e.target.checked })}
                        className="rounded border-gray-300 text-primary focus:ring-primary"
                      />
                      <span className="text-sm font-medium text-gray-700">Active</span>
                    </label>
                  </div>
                )}
              </div>
              <div className="mt-4 flex gap-3">
                <button
                  onClick={editingId ? () => handleUpdate(editingId) : handleCreate}
                  disabled={loading || !formData.name.trim()}
                  className="px-4 py-2 bg-primary text-white rounded-md text-sm font-medium hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Saving...' : editingId ? 'Update' : 'Create'}
                </button>
                <button
                  onClick={cancelEdit}
                  disabled={loading}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-300 disabled:opacity-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {loading && !suppliers.length ? (
            <div className="text-center py-12 text-gray-500">Loading suppliers...</div>
          ) : filteredSuppliers.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              {filterActive ? 'No active suppliers found.' : 'No suppliers found.'}
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Name
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Initials
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Contact Info
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredSuppliers.map((supplier) => (
                    <tr key={supplier.id} className={!supplier.isActive ? 'bg-gray-50 opacity-60' : ''}>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-gray-900">{supplier.name}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-gray-600">
                          {supplier.initials ? (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              {supplier.initials}
                            </span>
                          ) : (
                            <span className="text-gray-400">‚Äî</span>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-gray-600">{supplier.contactInfo || '‚Äî'}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          supplier.isActive
                            ? 'bg-green-100 text-green-800'
                            : 'bg-gray-100 text-gray-800'
                        }`}>
                          {supplier.isActive ? 'Active' : 'Inactive'}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div className="flex gap-2">
                          <button
                            onClick={() => startEdit(supplier)}
                            disabled={loading || editingId || showAddForm}
                            className="text-primary hover:text-primary-hover disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            Edit
                          </button>
                          {supplier.isActive && (
                            <button
                              onClick={() => handleDelete(supplier.id)}
                              disabled={loading || editingId}
                              className="text-red-600 hover:text-red-800 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              Deactivate
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          <div className="mt-4 text-sm text-gray-500">
            Showing {filteredSuppliers.length} of {suppliers.length} supplier(s)
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>

